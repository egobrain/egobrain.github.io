<!DOCTYPE html> <!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]--> <!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]--> <!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]--> <head> <meta charset="utf-8"> <title>Erlang ORM. Часть 2 - Egobrain</title> <meta name="author" content="Kozlov Yakov"> <meta name="description" content="Erlang ORM. Генерация boilerplate кода. Работа с БД"> <meta name="keywords" content="erlang, orm, parse_transform, **tq_db**, 'генерация кода', boilerplate"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="canonical" href="http://www.egobrain.ru/blog/2014/02/26/erlang-orm-part-2"> <link href="/favicon.png" rel="icon"> <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css"> <link href="/atom.xml" rel="alternate" title="Egobrain" type="application/atom+xml"> <script src="/javascripts/modernizr-3.0.js"></script> <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script> <script src="/javascripts/octopress.js" type="text/javascript"></script> <link href='http://fonts.googleapis.com/css?family=Yeseva+One' rel='stylesheet' type='text/css'> <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30472012-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script> </head> <body> <header role="banner"><hgroup> <h1><a href="/">Egobrain</a></h1> <h2></h2> </hgroup> </header> <nav role="navigation"><ul class="subscription" data-subscription="rss"> <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li> </ul> <form action="http://google.com/search" method="get"> <fieldset role="search"> <input type="hidden" name="q" value="site:www.egobrain.ru"/> <input class="search" type="text" name="q" results="0" placeholder="Поиск"/> </fieldset> </form> <ul class="main-navigation"> <li><a href="/blog">Блог</a></li> <li><a href="https://github.com/egobrain">Проекты</a></li> </ul> </nav> <div id="main"> <div id="content"> <div> <article class="hentry" role="article"> <header> <h1 class="entry-title">Erlang ORM. Часть 2</h1> <p class="meta"> <time datetime="2014-02-26T06:22:23+04:00" pubdate data-updated="true">Ср, 26 Фев 2014</time> </p> </header> <div class="entry-content"><p>В <a href="/blog/2014/02/19/erlang-orm-part-1">прошлой части</a> я говорил про генерацию модели, но так и не осветил как соединить генерацию моделей и работу с БД. Сейчас это исправлю.</p> <p>Все примеры Sql буду приводить с использованием PostgreSQL (<a href="https://github.com/wg/epgsql">epgsql</a>) и драйвер для <strong>tq_db</strong> <a href="https://github.com/egobrain/tq_postgres_driver">tq_postgres_driver</a>.</p> <h1>Meta</h1> <p>Для того, чтобы управлять моделями требуется большое количество мета информации. Есть много способов ее хранить но я выбрал оптимальный для себя &ndash; функция <code>$meta/1</code>.<br/> Она аргументом принимает ключ запрашиваемых данных.<br/> Первым символом идет знак &ldquo;$&rdquo; (из-за этого приходится весь атом обрамлять в одинарные кавычки), это сделано для того чтобы подчеркнуть, что функция является системной и ее не желательно использовать в бизнес логике.<br/> Также определена функция <code>$meta/2</code>, которая просто пробрасывает вызов на <code>$meta/1</code>, но нужна для работы механизма вызова через кортеж.</p> <figure class='code'><figcaption><span>db_user.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">&#39;$meta&#39;</span><span class="p">(</span><span class="nv">Opt</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">...</span> <span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">&#39;$meta&#39;</span><span class="p">(</span><span class="nv">Opt</span><span class="p">,</span> <span class="p">_</span><span class="nv">User</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">&#39;$meta&#39;</span><span class="p">(</span><span class="nv">Opt</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">db_user</span><span class="p">:</span><span class="nf">&#39;$meta&#39;</span><span class="p">(</span><span class="nv">Opt</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="c">%% То же самое, что и</span>
</span><span class='line'>
</span><span class='line'><span class="nv">User</span> <span class="o">=</span> <span class="nn">db_user</span><span class="p">:</span><span class="nf">new</span><span class="p">().</span>
</span><span class='line'><span class="nv">User</span><span class="p">:</span><span class="nf">&#39;$meta&#39;</span><span class="p">(</span><span class="nv">Opt</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure> <p>Опции которые по умолчанию задает <strong>tq_transform</strong>:</p> <ul> <li><code>module</code> &ndash; возвращает имя модуля для модели</li> <li><code>{record_index,Field}</code> &ndash; позиция поля <em>Field</em> в модели</li> </ul> <p><strong>tq_db</strong> расширяет этот список еще несколькими:</p> <ul> <li><code>table</code> &ndash; имя таблицы Sql</li> <li><code>indexes</code> &ndash; список индексных полей</li> <li><code>{db_type, Field}</code> &ndash; тип поля <em>Field</em> в базе данных</li> <li><code>{db_alias, Field}</code> &ndash; имя поля <em>Field</em> в базе данных</li> <li><code>{db_fields, r}</code> &ndash; список полей, которые разрешено писать в БД</li> <li><code>{db_fields, w}</code> &ndash; список полей, которые разрешено читать из БД</li> </ul> <p>Для генерации <strong>tq_db</strong> необходимо использовать <code>tq_sqlmodel_transform</code> <em>parse_transform</em>, обязательно должна быть указана опция модели <code>table</code>, заданы БД типы для полей и хотя бы одно из них должно быть индексное.</p> <figure class='code'><figcaption><span>db_user.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">db_user</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">compile</span><span class="p">({</span><span class="n">parse_transform</span><span class="p">,</span> <span class="n">tq_sqlmodel_transform</span><span class="p">}).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">field</span><span class="p">({</span><span class="n">id</span><span class="p">,</span>
</span><span class='line'>    <span class="p">[</span>
</span><span class='line'>     <span class="n">index</span><span class="p">,</span>
</span><span class='line'>     <span class="p">{</span><span class="n">type</span><span class="p">,</span> <span class="n">integer</span><span class="p">},</span>
</span><span class='line'>     <span class="p">{</span><span class="n">db_type</span><span class="p">,</span> <span class="n">integer</span><span class="p">}</span>
</span><span class='line'>    <span class="p">]}).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">field</span><span class="p">({</span><span class="n">login</span><span class="p">,</span>
</span><span class='line'>    <span class="p">[</span>
</span><span class='line'>     <span class="p">{</span><span class="n">type</span><span class="p">,</span> <span class="n">non_empty_binary</span><span class="p">},</span>
</span><span class='line'>     <span class="n">required</span><span class="p">,</span>
</span><span class='line'>     <span class="p">{</span><span class="n">db_type</span><span class="p">,</span> <span class="n">varchar</span><span class="p">},</span>
</span><span class='line'>     <span class="p">{</span><span class="n">validators</span><span class="p">,</span>
</span><span class='line'>        <span class="p">[</span>
</span><span class='line'>         <span class="p">{</span><span class="n">validators</span><span class="p">,</span> <span class="n">login</span><span class="p">}</span>
</span><span class='line'>        <span class="p">]}</span>
</span><span class='line'>    <span class="p">]}).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">field</span><span class="p">({</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>    <span class="p">[</span>
</span><span class='line'>     <span class="p">{</span><span class="n">type</span><span class="p">,</span> <span class="n">non_empty_binary</span><span class="p">},</span>
</span><span class='line'>     <span class="p">{</span><span class="n">db_type</span><span class="p">,</span> <span class="n">varchar</span><span class="p">},</span>
</span><span class='line'>     <span class="p">{</span><span class="n">validators</span><span class="p">,</span>
</span><span class='line'>        <span class="p">[</span>
</span><span class='line'>         <span class="p">{</span><span class="n">validators</span><span class="p">,</span> <span class="n">email</span><span class="p">}</span>
</span><span class='line'>        <span class="p">]}</span>
</span><span class='line'>    <span class="p">]}).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">field</span><span class="p">({</span><span class="n">password</span><span class="p">,</span>
</span><span class='line'>    <span class="p">[</span>
</span><span class='line'>     <span class="p">{</span><span class="n">type</span><span class="p">,</span> <span class="n">non_empty_binary</span><span class="p">},</span>
</span><span class='line'>     <span class="n">required</span><span class="p">,</span>
</span><span class='line'>     <span class="p">{</span><span class="n">db_type</span><span class="p">,</span> <span class="n">varchar</span><span class="p">},</span>
</span><span class='line'>     <span class="p">{</span><span class="n">validators</span><span class="p">,</span>
</span><span class='line'>        <span class="p">[</span>
</span><span class='line'>         <span class="p">{</span><span class="n">validators</span><span class="p">,</span> <span class="n">min_length</span><span class="p">,</span> <span class="p">[</span><span class="mi">6</span><span class="p">]}</span>
</span><span class='line'>        <span class="p">]}</span>
</span><span class='line'>    <span class="p">]}).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">field</span><span class="p">({</span><span class="n">salt</span><span class="p">,</span>
</span><span class='line'>    <span class="p">[</span>
</span><span class='line'>     <span class="p">{</span><span class="n">type</span><span class="p">,</span> <span class="n">binary</span><span class="p">},</span>
</span><span class='line'>     <span class="p">{</span><span class="n">db_type</span><span class="p">,</span> <span class="n">varchar</span><span class="p">},</span>
</span><span class='line'>     <span class="n">required</span>
</span><span class='line'>    <span class="p">]}).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">model</span><span class="p">([</span>
</span><span class='line'>     <span class="p">{</span><span class="n">table</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;users&quot;</span><span class="o">&gt;&gt;</span><span class="p">}</span>
</span><span class='line'>    <span class="p">])</span>
</span></code></pre></td></tr></table></div></figure> <h1>Sql injection</h1> <p>Метод защиты от sql инъекций будет достаточно простой: каждому аргументу, который будет подставлен в результирующий Sql запрос в пару должно быть дописано описание типа, которое укажет драйверу БД как работать с этими данными. Драйвер должен взять на себя всю ответственность по проверке и экранированию данных.</p> <p>Например:</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="k">query</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;SELECT * FROM users WHERE id = $1&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="p">[{</span><span class="n">integer</span><span class="p">,</span> <span class="mi">1</span><span class="p">}]).</span>
</span></code></pre></td></tr></table></div></figure> <h1>Connection pool</h1> <p>Для работы с БД желательно использовать пул подключений. Имя пула может быть явно указан при генерации модели.</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">model</span><span class="p">([</span>
</span><span class='line'>     <span class="p">{</span><span class="n">pool_name</span><span class="p">,</span> <span class="n">db</span><span class="p">}</span>
</span><span class='line'>    <span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <p>По умолчанию используется пул с именем <code>db</code>.</p> <p>Логика работы пула должна быть полностью реализована драйвером.</p> <h1>Select</h1> <p>Вспомним структуру модели <em>db_user</em>.</p> <p>Типичный запрос для получения данных выглядит так:</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">C</span><span class="p">}</span> <span class="o">=</span> <span class="nn">pgsql</span><span class="p">:</span><span class="nf">connect</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="s">&quot;postgres&quot;</span><span class="p">,</span> <span class="s">&quot;password&quot;</span><span class="p">,</span> <span class="p">[{</span><span class="n">database</span><span class="p">,</span> <span class="s">&quot;users&quot;</span><span class="p">}]).</span>
</span><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">_</span><span class="nv">Columnts</span><span class="p">,</span> <span class="nv">Rows</span><span class="p">}</span> <span class="o">=</span> <span class="nn">pgsql</span><span class="p">:</span><span class="nf">equery</span><span class="p">(</span><span class="nv">C</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;SELECT login, email, password, salt FROM users&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="p">[]).</span>
</span></code></pre></td></tr></table></div></figure> <p>Теперь в <code>Rows</code> лежит кортеж <code>{Login, Email, Password, Salt}</code>.</p> <p>Теперь понадобится функция для преобразования этого кортежа в нашу модель.</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">to_model</span><span class="p">({</span><span class="nv">Login</span><span class="p">,</span> <span class="nv">Email</span><span class="p">,</span> <span class="nv">Password</span><span class="p">,</span> <span class="nv">Salt</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">User</span> <span class="o">=</span> <span class="nn">db_user</span><span class="p">:</span><span class="nf">new</span><span class="p">(),</span>
</span><span class='line'>    <span class="nv">User2</span> <span class="o">=</span> <span class="nv">User</span><span class="p">:</span><span class="nf">set_login</span><span class="p">(</span><span class="nv">Login</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">User3</span> <span class="o">=</span> <span class="nv">User2</span><span class="p">:</span><span class="nf">set_email</span><span class="p">(</span><span class="nv">Email</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">User4</span> <span class="o">=</span> <span class="nv">User3</span><span class="p">:</span><span class="nf">set_password</span><span class="p">(</span><span class="nv">Password</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">User</span><span class="p">:</span><span class="nf">set_salt</span><span class="p">(</span><span class="nv">Salt</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure> <p>Можно ввести дополнительную функцию, которая будет принимать запрос и функцию конструктор и возвращать список полученных моделей:</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="k">query</span><span class="p">(</span><span class="nv">C</span><span class="p">,</span> <span class="nv">Sql</span><span class="p">,</span> <span class="nv">Args</span><span class="p">,</span> <span class="nv">Constructor</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">_</span><span class="nv">Columnts</span><span class="p">,</span> <span class="nv">Rows</span><span class="p">}</span> <span class="o">=</span> <span class="nn">pgsql</span><span class="p">:</span><span class="nf">equery</span><span class="p">(</span><span class="nv">C</span><span class="p">,</span> <span class="nv">Sql</span><span class="p">,</span> <span class="nv">Args</span><span class="p">),</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">Constructor</span><span class="p">(</span><span class="nv">Row</span><span class="p">)</span> <span class="p">||</span> <span class="nv">Row</span> <span class="o">&lt;-</span> <span class="nv">Rows</span><span class="p">].</span>
</span></code></pre></td></tr></table></div></figure> <p>и использовать ее так:</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">C</span><span class="p">}</span> <span class="o">=</span> <span class="nn">pgsql</span><span class="p">:</span><span class="nf">connect</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="s">&quot;postgres&quot;</span><span class="p">,</span> <span class="s">&quot;password&quot;</span><span class="p">,</span> <span class="p">[{</span><span class="n">database</span><span class="p">,</span> <span class="s">&quot;users&quot;</span><span class="p">}]).</span>
</span><span class='line'><span class="k">query</span><span class="p">(</span><span class="nv">C</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;SELECT login, email, password, salt FROM users&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="p">[],</span> <span class="k">fun</span> <span class="n">to_model</span><span class="o">/</span><span class="mi">1</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure> <p>Функция <code>to_model/1</code> получилась не универсальной, т.к. фиксировано количество полей, которые должны возвращаться из БД. Устраним этот досадный недостаток, введя функции <code>field_constructor(FieldName)</code>, которая возвращает <em>Setter</em> для поля, и <code>constructor(Fields)</code>, которая принимает список полей модели и возвращает аналог <code>to_model/1</code> для преобразования кортежа в объект <em>db_user</em>.</p> <figure class='code'><figcaption><span>db_user.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">field_constructor</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="o">-&gt;</span>     <span class="k">fun</span> <span class="nn">db_user</span><span class="p">:</span><span class="n">set_login</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
</span><span class='line'><span class="nf">field_constructor</span><span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="o">-&gt;</span>     <span class="k">fun</span> <span class="nn">db_user</span><span class="p">:</span><span class="n">set_email</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
</span><span class='line'><span class="nf">field_constructor</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">-&gt;</span>  <span class="k">fun</span> <span class="nn">db_user</span><span class="p">:</span><span class="n">set_password</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
</span><span class='line'><span class="nf">field_constructor</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span> <span class="o">-&gt;</span>      <span class="k">fun</span> <span class="nn">db_user</span><span class="p">:</span><span class="n">set_salt</span><span class="o">/</span><span class="mi">2</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">constructor</span><span class="p">(</span><span class="nv">Fields</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">fun</span><span class="p">(</span><span class="nv">Data</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nv">Setters</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_constructor</span><span class="p">(</span><span class="nv">F</span><span class="p">)</span> <span class="p">||</span> <span class="nv">F</span> <span class="o">&lt;-</span> <span class="nv">Fields</span><span class="p">],</span>
</span><span class='line'>        <span class="nv">DataList</span> <span class="o">=</span> <span class="nb">tuple_to_list</span><span class="p">(</span><span class="nv">Data</span><span class="p">),</span>
</span><span class='line'>        <span class="nv">SettersDataList</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">zip</span><span class="p">(</span><span class="nv">Setters</span><span class="p">,</span> <span class="nv">DataList</span><span class="p">),</span>
</span><span class='line'>        <span class="nn">lists</span><span class="p">:</span><span class="nf">foldl</span><span class="p">(</span>
</span><span class='line'>            <span class="k">fun</span><span class="p">({</span><span class="nv">Set</span><span class="p">,</span> <span class="nv">Val</span><span class="p">},</span> <span class="nv">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Set</span><span class="p">(</span><span class="nv">Val</span><span class="p">,</span> <span class="nv">User</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
</span><span class='line'>            <span class="nn">db_user</span><span class="p">:</span><span class="nf">new</span><span class="p">(),</span>
</span><span class='line'>            <span class="nv">SettersDataList</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure> <p>Кода больше, но он более универсален.</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">C</span><span class="p">}</span> <span class="o">=</span> <span class="nn">pgsql</span><span class="p">:</span><span class="nf">connect</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="s">&quot;postgres&quot;</span><span class="p">,</span> <span class="s">&quot;password&quot;</span><span class="p">,</span> <span class="p">[{</span><span class="n">database</span><span class="p">,</span> <span class="s">&quot;users&quot;</span><span class="p">}]).</span>
</span><span class='line'><span class="k">query</span><span class="p">(</span><span class="nv">C</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;SELECT login, email, password, salt FROM users&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="p">[],</span>
</span><span class='line'>    <span class="nn">db_user</span><span class="p">:</span><span class="nf">constructor</span><span class="p">([</span><span class="n">login</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="p">])).</span>
</span><span class='line'>
</span><span class='line'><span class="c">% или</span>
</span><span class='line'>
</span><span class='line'><span class="k">query</span><span class="p">(</span><span class="nv">C</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;SELECT login, email FROM users&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="p">[],</span>
</span><span class='line'>    <span class="nn">db_user</span><span class="p">:</span><span class="nf">constructor</span><span class="p">([</span><span class="n">login</span><span class="p">,</span> <span class="n">email</span><span class="p">])).</span>
</span></code></pre></td></tr></table></div></figure> <p>Если при выгрузке данных потребуется сделать преобразование поля <code>from_db</code>, то следует изменить конструктор поля, к примеру:</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">...</span>
</span><span class='line'><span class="nf">field_constructor</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">fun</span><span class="p">(</span><span class="nv">Val</span><span class="p">,</span> <span class="nv">User</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nv">NewVal</span> <span class="o">=</span> <span class="n">from_db</span><span class="p">(</span><span class="nv">Val</span><span class="p">),</span>
</span><span class='line'>        <span class="nv">User</span><span class="p">:</span><span class="nf">set_login</span><span class="p">(</span><span class="nv">NewVal</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure> <p><strong>tq_sqlmodel_transform</strong> может генерировать функции <code>get</code> и <code>find</code> для модели. Для этого надо явно указать через опцию модели</p> <figure class='code'><figcaption><span>db_user.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">model</span><span class="p">([</span>
</span><span class='line'>     <span class="p">...</span>
</span><span class='line'>     <span class="p">{</span><span class="n">generate</span><span class="p">,</span> <span class="p">[</span><span class="nb">get</span><span class="p">,</span> <span class="n">find</span><span class="p">]}</span>
</span><span class='line'>    <span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <p><code>get</code> &ndash; Арность функции равна количеству индексных полей модели.<br/> <code>find(Query, Args)</code> &ndash; принимает в качестве параметров запрос <em>Query</em>, который представляет собой dsl и должен обрабатываться далее. Поговорим об это позже.</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='erl'><span class='line'><span class="gp">1&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">User</span><span class="p">}</span> <span class="o">=</span> <span class="nn">db_user</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span>
</span><span class='line'><span class="gp">2&gt;</span> <span class="nv">User</span><span class="p">:</span><span class="nf">login</span><span class="p">().</span>
</span><span class='line'><span class="go">&lt;&lt;&quot;my_login&quot;&gt;&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="gp">3&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Users</span><span class="p">}</span> <span class="o">=</span> <span class="nn">db_user</span><span class="p">:</span><span class="nf">find</span><span class="p">(</span><span class="o">&lt;&lt;&gt;&gt;</span><span class="p">,</span> <span class="p">[]).</span> <span class="c">% Select all</span>
</span><span class='line'><span class="gp">4&gt;</span> <span class="p">[</span><span class="nv">U</span><span class="p">:</span><span class="nf">login</span><span class="p">()</span> <span class="p">||</span> <span class="nv">U</span> <span class="o">&lt;-</span> <span class="nv">Users</span><span class="p">].</span>
</span><span class='line'><span class="go">[&lt;&lt;&quot;my_login&quot;&gt;&gt;, ...].</span>
</span></code></pre></td></tr></table></div></figure> <p>Помимо представленных, для получения данных из БД можно воспользоваться более низкоуровневыми функциями из модулей <code>tq_sql</code> и <code>tq_dsl</code>.</p> <h1>Save</h1> <p>Для сохранения модели понадобится флаг <code>is_new</code>, который показывает является ли она новой или нет. В конструкторе должны быть сброшены флаг <code>is_new</code> и флаги изменения полей (<code>_changed</code>).</p> <figure class='code'><figcaption><span>db_user.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">db_user</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="n">is_new</span> <span class="o">=</span> <span class="n">false</span>
</span><span class='line'><span class="p">}).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">new</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nl">#db_user</span><span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="n">is_new</span> <span class="o">=</span> <span class="n">true</span>
</span><span class='line'>    <span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="nf">field_constructor</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">fun</span><span class="p">(</span><span class="nv">Val</span><span class="p">,</span> <span class="nv">User</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nv">User</span><span class="p">:</span><span class="nf">set_login</span><span class="p">(</span><span class="nv">Val</span><span class="p">),</span>
</span><span class='line'>        <span class="nv">User</span><span class="nl">#db_user</span><span class="p">{</span><span class="n">login_changed</span><span class="o">=</span><span class="n">false</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="nf">constructor</span><span class="p">(</span><span class="nv">Fields</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">fun</span><span class="p">(</span><span class="nv">Data</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nv">Setters</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_constructor</span><span class="p">(</span><span class="nv">F</span><span class="p">)</span> <span class="p">||</span> <span class="nv">F</span> <span class="o">&lt;-</span> <span class="nv">Fields</span><span class="p">],</span>
</span><span class='line'>        <span class="nv">DataList</span> <span class="o">=</span> <span class="nb">tuple_to_list</span><span class="p">(</span><span class="nv">Data</span><span class="p">),</span>
</span><span class='line'>        <span class="nv">SettersDataList</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">zip</span><span class="p">(</span><span class="nv">Setters</span><span class="p">,</span> <span class="nv">DataList</span><span class="p">),</span>
</span><span class='line'>        <span class="nn">lists</span><span class="p">:</span><span class="nf">foldl</span><span class="p">(</span>
</span><span class='line'>            <span class="k">fun</span><span class="p">({</span><span class="nv">Set</span><span class="p">,</span> <span class="nv">Val</span><span class="p">},</span> <span class="nv">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">Set</span><span class="p">(</span><span class="nv">Val</span><span class="p">,</span> <span class="nv">User</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
</span><span class='line'>            <span class="nl">#db_user</span><span class="p">{</span><span class="n">is_new</span><span class="o">=</span><span class="n">false</span><span class="p">},</span>
</span><span class='line'>            <span class="nv">SettersDataList</span><span class="p">)</span>
</span><span class='line'>     <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure> <p>Так же добавим функцию <code>is_new/1</code></p> <figure class='code'><figcaption><span>db_user.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">is_new</span><span class="p">(</span><span class="nv">User</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">User</span><span class="nl">#db_user</span><span class="p">{</span><span class="n">is_new</span> <span class="o">=</span> <span class="n">true</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure> <p>Наконец-таки перейдем к сохранению модели.<br/> Необходимо проверить является ли модель новой и, в зависимости от результата, выполнить <em>insert</em> или <em>update</em>.</p> <figure class='code'><figcaption><span>db_user.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">save</span><span class="p">(</span><span class="nv">User</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nv">User</span><span class="p">:</span><span class="nf">is_new</span><span class="p">()</span> <span class="k">of</span>
</span><span class='line'>        <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="c">% INSERT</span>
</span><span class='line'>        <span class="n">false</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="c">% UPDATE</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure> <p>Я не хочу отправлять в БД все поля, буду передавать только реально измененные:</p> <figure class='code'><figcaption><span>db_user.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">db_changed_fields</span><span class="p">(</span><span class="nv">Model</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">[</span>
</span><span class='line'>     <span class="p">{</span><span class="nv">Name</span><span class="p">,</span><span class="nv">Val</span><span class="p">}</span> <span class="p">||</span>
</span><span class='line'>        <span class="p">{</span><span class="nv">Name</span><span class="p">,</span><span class="nv">Val</span><span class="p">,</span><span class="n">true</span><span class="p">}</span> <span class="o">&lt;-</span>
</span><span class='line'>            <span class="p">[</span>
</span><span class='line'>             <span class="p">{</span><span class="n">login</span><span class="p">,</span> <span class="nv">User</span><span class="nl">#db_init.login</span><span class="p">,</span> <span class="nv">User</span><span class="nl">#db_user.login_changed</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="n">email</span><span class="p">,</span> <span class="nv">User</span><span class="nl">#db_init.email</span><span class="p">,</span> <span class="nv">User</span><span class="nl">#db_user.email_changed</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="n">password</span><span class="p">,</span> <span class="nv">User</span><span class="nl">#db_init.password</span><span class="p">,</span> <span class="nv">User</span><span class="nl">#db_user.password_changed</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="n">salt</span><span class="p">,</span> <span class="nv">User</span><span class="nl">#db_init.salt</span><span class="p">,</span> <span class="nv">User</span><span class="nl">#db_user.salt_changed</span><span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>    <span class="p">].</span>
</span></code></pre></td></tr></table></div></figure> <p>В списке должны быть только те поля, которые храняться в БД.</p> <p>Если понадобиться перед сохранением сделать преобразвание полея <code>to_db</code>, то следует изменить реализацию этой функции на следующую:</p> <figure class='code'><figcaption><span>db_user.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">db_changed_fields</span><span class="p">(</span><span class="nv">Model</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">[</span>
</span><span class='line'>     <span class="p">{</span><span class="nv">Name</span><span class="p">,</span><span class="nv">Val</span><span class="p">()}</span> <span class="p">||</span>
</span><span class='line'>        <span class="p">{</span><span class="nv">Name</span><span class="p">,</span><span class="nv">Val</span><span class="p">,</span><span class="n">true</span><span class="p">}</span> <span class="o">&lt;-</span>
</span><span class='line'>            <span class="p">[</span>
</span><span class='line'>             <span class="p">{</span><span class="n">login</span><span class="p">,</span>
</span><span class='line'>              <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">to_db</span><span class="p">(</span><span class="nv">User</span><span class="nl">#db_init.login</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
</span><span class='line'>              <span class="nv">User</span><span class="nl">#db_user.login_changed</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>              <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nv">User</span><span class="nl">#db_init.email</span> <span class="k">end</span><span class="p">,</span>
</span><span class='line'>              <span class="nv">User</span><span class="nl">#db_user.email_changed</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="n">password</span><span class="p">,</span>
</span><span class='line'>              <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nv">User</span><span class="nl">#db_init.password</span> <span class="k">end</span><span class="p">,</span>
</span><span class='line'>              <span class="nv">User</span><span class="nl">#db_user.password_changed</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="n">salt</span><span class="p">,</span>
</span><span class='line'>              <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nv">User</span><span class="nl">#db_init.salt</span> <span class="k">end</span><span class="p">,</span>
</span><span class='line'>              <span class="nv">User</span><span class="nl">#db_user.salt_changed</span><span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>    <span class="p">].</span>
</span></code></pre></td></tr></table></div></figure> <p>Я не буду приводить тут пример как реализовать в общем виде генерацию Sql для <code>insert</code> и <code>update</code>, имея всю мета информацию и данные &ndash; это будет тривиальным заданием. Кому интересно &ndash; могут посмотреть пример реализации из postgres драйвера: <a href="https://github.com/egobrain/tq_postgres_driver/blob/8ee00d059ae2400ec55002ea36770270b9e973aa/src/tq_postgres_driver_runtime.erl#L91">insert</a>, <a href="https://github.com/egobrain/tq_postgres_driver/blob/8ee00d059ae2400ec55002ea36770270b9e973aa/src/tq_postgres_driver_runtime.erl#L119">update</a></p> <p>Необходимость генерации функции <code>save</code> нужно указать через опцию модели <code>generate</code>.</p> <figure class='code'><figcaption><span>db_user.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">model</span><span class="p">([</span>
</span><span class='line'>     <span class="p">...</span>
</span><span class='line'>     <span class="p">{</span><span class="n">generate</span><span class="p">,</span> <span class="p">[</span><span class="n">save</span><span class="p">,</span> <span class="p">...]}</span>
</span><span class='line'>    <span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <h1>Hooks</h1> <p>Полезно иметь возможность задавать хуки для операций <code>save</code> и <code>delete</code>. Для этого в реализацию методов <code>save</code> добавляются пред и пост условия.</p> <figure class='code'><figcaption><span>db_user.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">save</span><span class="p">(</span><span class="nv">Model</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">before_save_hook</span><span class="p">(</span><span class="nv">Model</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Model2</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="k">case</span> <span class="n">save_logic</span><span class="p">(</span><span class="nv">Model2</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>                <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Model3</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="n">after_save_hook</span><span class="p">(</span><span class="nv">Model</span><span class="p">,</span> <span class="nv">Model3</span><span class="p">);</span>
</span><span class='line'>                <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="p">_</span><span class="nv">Reason</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Err</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="nv">Err</span>
</span><span class='line'>            <span class="k">end</span><span class="p">;</span>
</span><span class='line'>        <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="p">_</span><span class="nv">Reason</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Err</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="nv">Err</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">delete</span><span class="p">(</span><span class="nv">Model</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">before_delete_hook</span><span class="p">(</span><span class="nv">Model</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Model2</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="k">case</span> <span class="n">save_logic</span><span class="p">(</span><span class="nv">Model2</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>                <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Model3</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="n">after_delete_hook</span><span class="p">(</span><span class="nv">Model</span><span class="p">,</span> <span class="nv">Model3</span><span class="p">);</span>
</span><span class='line'>                <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="p">_</span><span class="nv">Reason</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Err</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="nv">Err</span>
</span><span class='line'>            <span class="k">end</span><span class="p">;</span>
</span><span class='line'>        <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="p">_</span><span class="nv">Reason</span><span class="p">}</span> <span class="o">=</span> <span class="nv">Err</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="nv">Err</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure> <p>Обратите внимание, что хук <code>after_save_hook</code> отличается количеством аргументов. Иногда бывает полезно иметь доступ к изначальному состоянию модели, к примеру, для проверки выполнялось ли первое сохранение модели или же обновление старой.</p> <p>В <strong>tq_db</strong> хуки задаются через опции модели:</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">model</span><span class="p">([</span>
</span><span class='line'>     <span class="p">{</span><span class="n">before_save</span><span class="p">,</span> <span class="n">before_save_hook</span><span class="p">},</span>
</span><span class='line'>     <span class="p">{</span><span class="n">after_save</span><span class="p">,</span> <span class="n">after_save_hook</span><span class="p">},</span>
</span><span class='line'>
</span><span class='line'>     <span class="p">{</span><span class="n">before_delete</span><span class="p">,</span> <span class="n">before_delete_hook</span><span class="p">},</span>
</span><span class='line'>     <span class="p">{</span><span class="n">after_delete</span><span class="p">,</span> <span class="n">after_delete_hook</span><span class="p">}</span>
</span><span class='line'>    <span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <h1>SQL DSL.</h1> <p>Посмотрим на запрос на выборку данных</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erl'><span class='line'><span class="gp">1&gt;</span> <span class="n">equery</span><span class="p">(</span><span class="nv">C</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;SELECT login, email, password, salt FROM users WHERE id = $1&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
</span><span class='line'><span class="go">    [{integer, 1}]</span>
</span><span class='line'><span class="go">    db_user:constructor([login, email, password, salt])).</span>
</span></code></pre></td></tr></table></div></figure> <p>Что сразу мне не нравится:</p> <ul> <li>Я должен вручную писать <em>alias</em> поля в &ldquo;select&rdquo; части <em>Sql</em> запроса и имена полей в конструкторе и вручную контролировать корректность их заполения;</li> <li>в &ldquo;where&rdquo; части я должен вручную писать <em>alias</em>-ы полей;</li> <li>должен вручную вписывать типы аргументов для Args;</li> <li>вручную указывать в запросе имя таблицы.</li> </ul> <p>Я решил это дело автоматизировать путем введения дополнительных конструкций непосредственно в Sql.</p> <p>Получились такие такое расширение:</p> <ul> <li><code>$model.field_name</code> или <code>$field_name</code> &ndash; в sql вместо этой конструкции будет подставлен <em>alias</em> поля, полученный через <code>model:'$meta'({db_alias, field_name})</code>.</li> <li><code>~model.field_name</code> или <code>~field_name</code> &ndash; в местах этих конструкций будет вставлен аргумент из Args. Для аргумента будет автоматически подставлен тип model:<code>$meta'({db_type, field_name})</code>. (Например для <code>~id</code>, из аргумента 10 получится [{integer, 10}]).</li> <li><code>#model</code> &ndash; подстановка имени таблицы для модели <em>model</em> из <code>model:'$meta'({db_alias, field_name})</code>.</li> <li><code>@model.field_name</code> или <code>@field_name</code> &ndash; в sql вместо этой конструкции будет подставлен <em>alias</em> поля, полученный через <code>model:'$meta'({db_alias, field_name})</code>, <code>field_name</code> также будет подставлен в <code>constructor</code>.</li> <li><code>@model.field_name(...)</code> или <code>@field_name(...)</code> &ndash; <code>field_name</code> будет подставлен в <code>constructor</code>, но <em>alias</em> не попадет в sql. Например, для запроса <code>&lt;&lt;"SELECT @id(1)"&gt;&gt;</code>, в конструктор в качестве значения для поля id попадет 1.</li> <li><code>@model.*</code> или <code>@*</code> &ndash; извлечь все поля (которые помечены как <em>read</em>)</li> <li><code>@model...</code> или <code>@...</code> &ndash; извлечь поля, которые ранее не упоминались в этом sql запросе (которые помечены как <em>read</em>)</li> </ul> <p>Т.к. часто возникают коллизии по именам, их иногда следует писать в виде &ldquo;table_alias.field&rdquo;, для указания синонимов таблицы при подстановке алиасов полей можно использовать фигурные скобки:</p> <ul> <li><code>${table_alias}model.field_name</code> или <code>${table_alias}field_name</code></li> <li><code>@{table_alias}model.field_name</code> или <code>@{table_alias}field_name</code></li> <li><code>@{table_alias}model...</code> или <code>${table_alias}...</code></li> <li><p><code>@{table_alias}model.*</code> или <code>${table_alias}*</code></p> <blockquote><p>Весь представленый dsl был реализован для удовлетворения личных потребностей по работе с Sql. <strong>DSL реализуется драйвером</strong>, так что, при желании, его <strong>можно легко его заменить</strong> на свой.</p></blockquote></li> </ul> <p>Для работы с новым языком запросов используется модуль <code>tq_dsl</code>.</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">[</span><span class="nv">User</span><span class="p">]}</span> <span class="o">=</span> <span class="nn">tq_dsl</span><span class="p">:</span><span class="nf">model_query</span><span class="p">(</span><span class="nv">PoolName</span><span class="p">,</span> <span class="n">db_user</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;SELECT @* FROM #db_user WHERE $id = </span><span class="si">~i</span><span class="s">d&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <h1>Usage</h1> <p>Все готово к тому, чтобы привести комплексный пример. Перепишем модуль <em>db_user</em> по всем правилам, т.е. будем солить пароль при сохранении в БД, искать пользователя по связке <em>login</em> + <em>password</em> и т.п.</p> <p>Первое что нужно сделать &ndash; добавить драйвер <strong>tq_db</strong> в зависимости проекта, в моем случае это <code>tq_postgres_driver</code>:</p> <figure class='code'><figcaption><span>rebar.config </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">deps</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="n">tq_transform</span><span class="p">,</span> <span class="s">&quot;.*&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">git</span><span class="p">,</span> <span class="s">&quot;git://github.com/egobrain/tq_postgres_driver&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">tag</span><span class="p">,</span> <span class="s">&quot;0.1.0&quot;</span><span class="p">}}}</span>
</span><span class='line'>       <span class="p">]}.</span>
</span></code></pre></td></tr></table></div></figure> <p>Далее необходимо запутить драйвер и задать параметры пула подключений</p> <figure class='code'><figcaption><span>my_app.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">DbPool</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>         <span class="p">{</span><span class="nb">size</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">max_overflow</span><span class="p">,</span> <span class="mi">20</span><span class="p">},</span>
</span><span class='line'>
</span><span class='line'>         <span class="p">{</span><span class="n">hostname</span><span class="p">,</span> <span class="s">&quot;localhost&quot;</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">username</span><span class="p">,</span> <span class="s">&quot;postgres&quot;</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">password</span><span class="p">,</span> <span class="s">&quot;password&quot;</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">database</span><span class="p">,</span> <span class="s">&quot;users&quot;</span><span class="p">}]</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">% Load App</span>
</span><span class='line'>    <span class="nn">application</span><span class="p">:</span><span class="nf">load</span><span class="p">(</span><span class="n">tq_db</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">application</span><span class="p">:</span><span class="nf">set_env</span><span class="p">(</span><span class="n">tq_db</span><span class="p">,</span> <span class="n">pools</span><span class="p">,</span> <span class="p">[{</span><span class="n">db</span><span class="p">,</span> <span class="n">tq_postgres_driver</span><span class="p">,</span> <span class="nv">DbPool</span><span class="p">}]),</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">% Start Apps</span>
</span><span class='line'>    <span class="nn">application</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="n">tq_postgres_driver</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">application</span><span class="p">:</span><span class="nf">start</span><span class="p">(</span><span class="n">tq_db</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure> <p>описать модель</p> <figure class='code'><figcaption><span>db_user.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">db_user</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">compile</span><span class="p">({</span><span class="n">parse_transform</span><span class="p">,</span> <span class="n">tq_sqlmodel_transform</span><span class="p">}).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="nb">get</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">field</span><span class="p">({</span><span class="n">id</span><span class="p">,</span>
</span><span class='line'>        <span class="p">[</span>
</span><span class='line'>         <span class="n">index</span><span class="p">,</span>
</span><span class='line'>         <span class="p">{</span><span class="n">type</span><span class="p">,</span> <span class="n">non_neg_integer</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">db_type</span><span class="p">,</span> <span class="n">integer</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">mode</span><span class="p">,</span> <span class="n">r</span><span class="p">}</span>
</span><span class='line'>        <span class="p">]}).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">field</span><span class="p">({</span><span class="n">login</span><span class="p">,</span>
</span><span class='line'>        <span class="p">[</span>
</span><span class='line'>         <span class="n">required</span><span class="p">,</span>
</span><span class='line'>         <span class="p">{</span><span class="n">type</span><span class="p">,</span> <span class="n">non_empty_binary</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">db_type</span><span class="p">,</span> <span class="n">varchar</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">validators</span><span class="p">,</span>
</span><span class='line'>            <span class="p">[</span>
</span><span class='line'>             <span class="p">{</span><span class="n">validators</span><span class="p">,</span> <span class="n">min_length</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">]},</span>
</span><span class='line'>             <span class="p">{</span><span class="n">validators</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="p">[</span><span class="mi">32</span><span class="p">]},</span>
</span><span class='line'>             <span class="p">{</span><span class="n">validators</span><span class="p">,</span> <span class="n">login</span><span class="p">}</span>
</span><span class='line'>            <span class="p">]}</span>
</span><span class='line'>        <span class="p">]}).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">field</span><span class="p">({</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>        <span class="p">[</span>
</span><span class='line'>         <span class="n">required</span><span class="p">,</span>
</span><span class='line'>         <span class="p">{</span><span class="n">type</span><span class="p">,</span> <span class="n">non_empty_binary</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">db_type</span><span class="p">,</span> <span class="n">varchar</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">validators</span><span class="p">,</span>
</span><span class='line'>          <span class="p">[</span>
</span><span class='line'>           <span class="p">{</span><span class="n">validators</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="p">[</span><span class="mi">254</span><span class="p">]},</span>
</span><span class='line'>           <span class="p">{</span><span class="n">validators</span><span class="p">,</span> <span class="n">email</span><span class="p">}</span>
</span><span class='line'>          <span class="p">]}</span>
</span><span class='line'>        <span class="p">]}).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">field</span><span class="p">({</span><span class="n">password</span><span class="p">,</span>
</span><span class='line'>        <span class="p">[</span>
</span><span class='line'>         <span class="n">required</span><span class="p">,</span>
</span><span class='line'>         <span class="p">{</span><span class="n">type</span><span class="p">,</span> <span class="n">non_empty_binary</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">db_type</span><span class="p">,</span> <span class="n">varchar</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">mode</span><span class="p">,</span> <span class="n">srw</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">validators</span><span class="p">,</span>
</span><span class='line'>          <span class="p">[</span>
</span><span class='line'>           <span class="p">{</span><span class="n">validators</span><span class="p">,</span> <span class="n">min_length</span><span class="p">,</span> <span class="p">[</span><span class="mi">6</span><span class="p">]},</span>
</span><span class='line'>           <span class="p">{</span><span class="n">validators</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="p">[</span><span class="mi">64</span><span class="p">]}</span>
</span><span class='line'>          <span class="p">]}</span>
</span><span class='line'>        <span class="p">]}).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">field</span><span class="p">({</span><span class="n">salt</span><span class="p">,</span>
</span><span class='line'>        <span class="p">[</span>
</span><span class='line'>         <span class="n">required</span><span class="p">,</span>
</span><span class='line'>         <span class="p">{</span><span class="n">type</span><span class="p">,</span> <span class="n">non_empty_binary</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">db_type</span><span class="p">,</span> <span class="n">varchar</span><span class="p">},</span>
</span><span class='line'>         <span class="p">{</span><span class="n">mode</span><span class="p">,</span> <span class="n">srsw</span><span class="p">}</span>
</span><span class='line'>        <span class="p">]}).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">model</span><span class="p">([</span>
</span><span class='line'>        <span class="p">{</span><span class="n">table</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;user&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="n">generate</span><span class="p">,</span> <span class="p">[</span><span class="nb">get</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">find</span><span class="p">,</span> <span class="n">delete</span><span class="p">]},</span>
</span><span class='line'>        <span class="p">{</span><span class="n">before_save</span><span class="p">,</span> <span class="p">[</span><span class="n">valid</span><span class="p">,</span> <span class="n">salt_password</span><span class="p">]}</span>
</span><span class='line'>       <span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nb">get</span><span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="nv">Password</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">find</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;where $login = ~login limit 1&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Login</span><span class="p">])</span> <span class="k">of</span>
</span><span class='line'>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">[]}</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">unknown_login</span><span class="p">};</span>
</span><span class='line'>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">[</span><span class="nv">User</span><span class="p">]}</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="k">case</span> <span class="nb">hash</span><span class="p">(</span><span class="nv">Password</span><span class="p">,</span> <span class="nv">User</span><span class="p">:</span><span class="nf">salt</span><span class="p">())</span> <span class="o">=:=</span> <span class="nv">User</span><span class="p">:</span><span class="nf">password</span><span class="p">()</span> <span class="k">of</span>
</span><span class='line'>                <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">User</span><span class="p">};</span>
</span><span class='line'>                <span class="n">false</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">wrong_password</span><span class="p">}</span>
</span><span class='line'>            <span class="k">end</span><span class="p">;</span>
</span><span class='line'>        <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="p">_}</span> <span class="o">=</span> <span class="nv">Err</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="nv">Err</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">salt_password</span><span class="p">(</span><span class="nv">Model</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nv">Model</span><span class="p">:</span><span class="nf">is_changed</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>        <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="nv">Salt</span> <span class="o">=</span> <span class="n">gen_salt</span><span class="p">(),</span>
</span><span class='line'>            <span class="nv">SaltedPassword</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="nv">Model</span><span class="p">:</span><span class="nf">password</span><span class="p">(),</span> <span class="nv">Salt</span><span class="p">),</span>
</span><span class='line'>            <span class="nv">Model</span><span class="p">:</span><span class="nf">from_proplist</span><span class="p">(</span>
</span><span class='line'>                <span class="p">[</span>
</span><span class='line'>                 <span class="p">{</span><span class="n">salt</span><span class="p">,</span> <span class="nv">Salt</span><span class="p">},</span>
</span><span class='line'>                 <span class="p">{</span><span class="n">password</span><span class="p">,</span> <span class="nv">SaltedPassword</span><span class="p">}])</span>
</span><span class='line'>                <span class="p">]);</span>
</span><span class='line'>        <span class="p">_</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Model</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nb">hash</span><span class="p">(</span><span class="nv">Password</span><span class="p">,</span> <span class="nv">Salt</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nb">md5</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Password</span><span class="o">/</span><span class="n">binary</span><span class="p">,</span> <span class="nv">Salt</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">gen_salt</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nb">list_to_binary</span><span class="p">([</span><span class="nn">random</span><span class="p">:</span><span class="nf">uniform</span><span class="p">(</span><span class="mi">87</span><span class="p">)</span> <span class="o">+</span> <span class="mi">35</span> <span class="p">||</span> <span class="p">_</span> <span class="o">&lt;-</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)]).</span>
</span><span class='line'>
</span><span class='line'><span class="nb">md5</span><span class="p">(</span><span class="nv">Binary</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nb">iolist_to_binary</span><span class="p">(</span>
</span><span class='line'>      <span class="p">[</span>
</span><span class='line'>       <span class="nn">io_lib</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;</span><span class="si">~.16b</span><span class="s">&quot;</span><span class="p">,[</span><span class="nv">N</span><span class="p">])</span>
</span><span class='line'>       <span class="p">||</span> <span class="o">&lt;&lt;</span><span class="nv">N</span><span class="o">&gt;&gt;</span> <span class="o">&lt;=</span> <span class="nn">crypto</span><span class="p">:</span><span class="nb">hash</span><span class="p">(</span><span class="nb">md5</span><span class="p">,</span> <span class="nv">Binary</span><span class="p">)</span>
</span><span class='line'>      <span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <p>и, для полноты картины, валидаторы</p> <figure class='code'><figcaption><span>validators.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">validators</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span>
</span><span class='line'>         <span class="n">min_length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
</span><span class='line'>         <span class="n">max_length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
</span><span class='line'>         <span class="n">email</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span>
</span><span class='line'>         <span class="n">login</span><span class="o">/</span><span class="mi">1</span>
</span><span class='line'>        <span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">min_length</span><span class="p">(</span><span class="nv">MinLength</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">)</span> <span class="k">when</span> <span class="nb">byte_size</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nv">MinLength</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="p">{</span><span class="n">min_length</span><span class="p">,</span> <span class="nv">MinLength</span><span class="p">}};</span>
</span><span class='line'><span class="nf">min_length</span><span class="p">(_,</span> <span class="p">_)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">ok</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">max_length</span><span class="p">(</span><span class="nv">MaxLength</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">)</span> <span class="k">when</span> <span class="nb">byte_size</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nv">MaxLength</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="p">{</span><span class="n">max_length</span><span class="p">,</span> <span class="nv">MaxLength</span><span class="p">}};</span>
</span><span class='line'><span class="nf">max_length</span><span class="p">(_,</span> <span class="p">_)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">ok</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">regexp_match</span><span class="p">(</span><span class="nv">Re</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nn">re</span><span class="p">:</span><span class="nf">run</span><span class="p">(</span><span class="nv">Bin</span><span class="p">,</span> <span class="nv">Re</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>        <span class="p">{</span><span class="n">match</span><span class="p">,</span> <span class="p">_}</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="n">ok</span><span class="p">;</span>
</span><span class='line'>        <span class="n">nomatch</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">invalid</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">email</span><span class="p">(</span><span class="nv">Email</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">regexp_match</span><span class="p">(</span><span class="s">&quot;^[-</span><span class="se">\\</span><span class="s">w.]+@([A-z0-9][-A-z0-9]+</span><span class="se">\\</span><span class="s">.)+[A-z]{2,}$&quot;</span><span class="p">,</span> <span class="nv">Email</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">login</span><span class="p">(</span><span class="nv">Login</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">regexp_match</span><span class="p">(</span><span class="s">&quot;^</span><span class="se">\\</span><span class="s">w+([.-]?</span><span class="se">\\</span><span class="s">w+)+$&quot;</span><span class="p">,</span> <span class="nv">Login</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure> <p><strong>tq_db</strong> не создает схему таблицы в БД, так что вам придется завести ее самим.</p> <p>Пример использования:</p> <figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='erl'><span class='line'><span class="gp">1&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">User</span><span class="p">}</span> <span class="o">=</span> <span class="nn">db_user</span><span class="p">:</span><span class="nf">from_ext_proplist</span><span class="p">(</span>
</span><span class='line'><span class="go">    [</span>
</span><span class='line'><span class="go">     {&lt;&lt;&quot;login&quot;&gt;&gt;, &lt;&lt;&quot;my_login&quot;&gt;&gt;},</span>
</span><span class='line'><span class="go">     {&lt;&lt;&quot;password&quot;&gt;&gt;, &lt;&lt;&quot;123&quot;&gt;&gt;},</span>
</span><span class='line'><span class="go">     {&lt;&lt;&quot;email&quot;&gt;&gt;, &lt;&lt;&quot;my.login@my.mail.ru&quot;&gt;&gt;}</span>
</span><span class='line'><span class="go">    ], [safe]).</span>
</span><span class='line'><span class="gp">2&gt;</span> <span class="nv">User</span><span class="p">:</span><span class="nf">save</span><span class="p">().</span>
</span><span class='line'><span class="go">{error, [{password, {min_length, 6}}]}</span>
</span><span class='line'><span class="gp">3&gt;</span> <span class="nv">User2</span> <span class="o">=</span> <span class="nv">User</span><span class="p">:</span><span class="nf">set_password</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;123456&quot;</span><span class="o">&gt;&gt;</span><span class="p">).</span>
</span><span class='line'><span class="gp">4&gt;</span> <span class="nv">User2</span><span class="p">:</span><span class="nf">save</span><span class="p">().</span>
</span><span class='line'><span class="go">{ok, {db_user, ...}}</span>
</span><span class='line'><span class="gp">5&gt;</span> <span class="nn">db_user</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;login&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;123&quot;</span><span class="o">&gt;&gt;</span><span class="p">).</span>
</span><span class='line'><span class="go">{error, wrong_password}</span>
</span><span class='line'><span class="gp">6&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">User3</span><span class="p">}</span> <span class="o">=</span> <span class="nn">db_user</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;login&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;123456&quot;</span><span class="o">&gt;&gt;</span><span class="p">).</span>
</span><span class='line'><span class="gp">7&gt;</span> <span class="nv">User3</span><span class="p">:</span><span class="nf">id</span><span class="p">().</span>
</span><span class='line'><span class="go">1</span>
</span></code></pre></td></tr></table></div></figure> <p>На сегодня все. Но хочу сказать, что предстоит еще много работы для продолжения которой мне очень нужна обратная связь от сообщества, так что пишите мне, задавайте вопросы, говорите пожелания и давайте рекомендации&hellip; Спасибо за внимание.</p> </div> <footer> <p class="meta"> <span class="byline author vcard">Опубликовал <span class="fn">Kozlov Yakov</span></span> <time datetime="2014-02-26T06:22:23+04:00" pubdate data-updated="true">Ср, 26 Фев 2014</time> <span class="categories"> <a class='category' href='/blog/categories/erlang/'>erlang</a>, <a class='category' href='/blog/categories/fp/'>fp</a> </span> </p> <div class="sharing"> <a href="//twitter.com/share" class="twitter-share-button" data-url="http://www.egobrain.ru/blog/2014/02/26/erlang-orm-part-2/" data-via="" data-counturl="http://www.egobrain.ru/blog/2014/02/26/erlang-orm-part-2/">Tweet</a> <div class="g-plusone" data-size="medium"></div> </div> <p class="meta"> <a class="basic-alignment left" href="/blog/2014/02/19/erlang-orm-part-1/" title="Previous Post: Erlang ORM. Часть 1.">&laquo; Erlang ORM. Часть 1.</a> </p> </footer> </article> <section> <h1>Комментарии</h1> <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </section> </div> <aside class="sidebar"> <section> <h1>Коротко о себе</h1> <p> Привет! Меня зовут Яков. Этой мой блог об erlang, js, web-программировании, fp и прочем... </p> <p> Связаться со мной можно по @почте: xazar.studio@gmail.com </p> </section> <section> <h1>Недавние заметки</h1> <ul id="recent_posts"> <li class="post"> <a href="/blog/2014/02/26/erlang-orm-part-2/">Erlang ORM. Часть 2</a> </li> <li class="post"> <a href="/blog/2014/02/19/erlang-orm-part-1/">Erlang ORM. Часть 1.</a> </li> <li class="post"> <a href="/blog/2014/02/13/obrabotka-oshibok-poumolchaniiu-angularjs/">Обработка ошибок по умолчанию AngularJS</a> </li> </ul> </section> <section> <h1>GitHub Repos</h1> <ul id="gh_repos"> <li class="loading">Status updating...</li> </ul> <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'egobrain',
            count: 0,
            skip_forks: true,
            skip_projects: [ "dip_orm",  "egobrain.github.io",  "erlperf_tests", ],
            target: '#gh_repos'
        });
    });
  </script> <script src="/javascripts/github.js" type="text/javascript"> </script> </section> <section class="googleplus"> <h1> <a href="https://plus.google.com/113605909138563391004?rel=author"> <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32"> Google+ </a> </h1> </section> </aside> </div> </div> <footer role="contentinfo"><p> Copyright &copy; 2016 - Kozlov Yakov - <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> </p> </footer> <script type="text/javascript">
      var disqus_shortname = 'wwwegobrainru';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.egobrain.ru/blog/2014/02/26/erlang-orm-part-2/';
        var disqus_url = 'http://www.egobrain.ru/blog/2014/02/26/erlang-orm-part-2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script> <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script> <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script> <script type="text/javascript">
(function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter24052423 = new Ya.Metrika({id:24052423, enableAll: true});
        } catch(e) {}
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f);
    } else { f(); }
})(document, window, "yandex_metrika_callbacks");
</script> <noscript><div><img src="//mc.yandex.ru/watch/24052423" style="position:absolute; left:-9999px;" alt=""/></div></noscript> </body> </html>