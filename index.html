<!DOCTYPE html> <!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]--> <!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]--> <!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]--> <head> <meta charset="utf-8"> <title>Egobrain</title> <meta name="author" content="Kozlov Yakov"> <meta name="description" content="Прошло уже очень много времени с момента как я писал про свои эксперименты с Erlang ORM. И что я могу сказать? Первое и самое, вероятно, печальное, &hellip;"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="canonical" href="http://www.egobrain.ru"> <link href="/favicon.png" rel="icon"> <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css"> <link href="/atom.xml" rel="alternate" title="Egobrain" type="application/atom+xml"> <script src="/javascripts/modernizr-3.0.js"></script> <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script> <script src="/javascripts/octopress.js" type="text/javascript"></script> <link href='http://fonts.googleapis.com/css?family=Yeseva+One' rel='stylesheet' type='text/css'> <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30472012-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script> </head> <body> <header role="banner"><hgroup> <h1><a href="/">Egobrain</a></h1> <h2></h2> </hgroup> </header> <nav role="navigation"><ul class="subscription" data-subscription="rss"> <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li> </ul> <form action="http://google.com/search" method="get"> <fieldset role="search"> <input type="hidden" name="q" value="site:www.egobrain.ru"/> <input class="search" type="text" name="q" results="0" placeholder="Поиск"/> </fieldset> </form> <ul class="main-navigation"> <li><a href="/blog">Блог</a></li> <li><a href="https://github.com/egobrain">Проекты</a></li> </ul> </nav> <div id="main"> <div id="content"> <div class="blog-index"> <article> <header> <h1 class="entry-title"><a href="/blog/2016/06/02/erlang-orm-part-3/">Erlang ORM. часть 3</a></h1> <p class="meta"> <time datetime="2016-06-02T19:26:22+03:00" pubdate data-updated="true">Чт, 2 Июн 2016</time> </p> </header> <div class="entry-content"><p>Прошло уже очень много времени с момента как я писал про свои эксперименты с Erlang ORM.<br/> И что я могу сказать? <br/> Первое и самое, вероятно, печальное, подход оказался не жизнеспособным, Второе &ndash; несмотря на недостатки ORM ее использование помогло набраться опыта работы с postgresql из Erlang и получить представление о том как все действительно должно работать.</p> <p>Где я допустил ошибки:<br/> &ndash; Нельзя мешать в одной модели описание того как данные хранятся в базе и как будут отдаваться клиенту<br/> &ndash; Не стоило мешать генерацию sql и непосредственную работу с БД в одном проекте<br/> &ndash; Подход ActiveRecord &ndash; не самая лучшая идея для Erlang<br/> &ndash; Слишком много parse_transform-a</p> <p>За эти 2 года я очень часто сталкивался с генерацией sql в чужих проектах на Erlang и, к сожалению, единого, общепризнанного, да что там, хотя бы просто удобного решения нигде не встречал. Везде лишь ад из case блоков, сверток и iolist-ов. Что еще печальнее, коллеги все чаще стали поглядывать в сторону Elixir с его ecto. А уж совсем не хочется изучать, а тем более использовать в продакшене еще один язык.</p> <p>Так на свет появился стек для работы с postgresql и моделями данных:<br/> &ndash; <a href="https://github.com/egobrain/epgpool">epgpool</a> &ndash; простой пулл подключений к postgres. Очередной велосипед, если есть предложения чего-то получше &ndash; могу рассмотреть<br/> &ndash; <a href="https://github.com/egobrain/dbschema">dbschema</a> &ndash; автоматические миграции наше все. Библиотек позволяет исполнять sql и erl up/down инструкции. Что убирает кучу работы по ручной раскладке и позволяет автоматизировать тестирование<br/> &ndash; <a href="https://github.com/egobrain/emodel">emodel</a> &ndash; библиотека для валидации входных данных. Та самая прослойка, которая должна отделять чистые, проверенные данные от мусора, который к нам прилетает. Отличается тем, что возвращает сразу все ошибки до которых может дотянуться.<br/> &ndash; <a href="https://github.com/egobrain/equery">equery</a> &ndash; генерация sql, вдохновленная подходом Ecto<br/> &ndash; <a href="https://github.com/egobrain/repo">repo</a> &ndash; одна из возможных реализаций CRUD библиотеки поверх <a href="https://github.com/egobrain/equery">equery</a> и <a href="https://github.com/egobrain/epgpool">epgpool</a>.</p> <p>Сегодня я расскажу про <a href="https://github.com/egobrain/repo">repo</a> и <a href="https://github.com/egobrain/equery">equery</a>.</p> <h1>Equery</h1> <p>Какие проблемы с ручным написанием sql?<br/> 1. Как выразился один мой бывший коллега, основная проблема &ndash; смапить результат исполнения sql на внутреннюю структуру данных<br/> 2. Сложность композиции. (К примеру, как добавить еще один фильтр к уже имеющимся)<br/> 3. Необходимость модифицировать разрозненные запросы в случае добавления, удаления полей в таблице.</p> <p>Как будем решать?</p> <p>Итак, понадобится сущность, которая будет описывать структуру таблицы SQL (Благо в Erlang r17 появились мапы и с ними жизнь стала намного легче). Решение в лоб</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nv">Schema</span> <span class="o">=</span> <span class="err">#</span><span class="p">{</span>
</span><span class='line'>    <span class="n">fields</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span>
</span><span class='line'>       <span class="n">field_1</span> <span class="o">=&gt;</span> <span class="nv">Fields1Opts</span><span class="p">,</span>
</span><span class='line'>       <span class="n">field_2</span> <span class="o">=&gt;</span> <span class="nv">Fields2Opts</span><span class="p">,</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="n">table</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&quot;SomeTableName&quot;</span><span class="o">&gt;&gt;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> <p>FieldOpts &ndash; Набор дополнительной информации о колонках. Например:<br/> &ndash; type &ndash; тип в бд ({varchar, 255}, decimal, int, text, bigint, &hellip;)<br/> &ndash; required &ndash; аналог NOT NULL (boolean)<br/> &ndash; readOnly &ndash; удобная опция, в случае если поле нельзя обновлять, например id, который генерируется через serial или timestamp через now()<br/> &ndash; index &ndash; поле является индексом, или частью составного индекса (boolean)<br/> &ndash; &hellip; &ndash; что угодно. Т.к. Opts &ndash; это map(), то можно добавлять свои опции по желанию.</p> <p>К этому моменту у меня примерно прояснилась картина, как я хочу видеть код.</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nv">Query1</span> <span class="o">=</span> <span class="n">from</span><span class="p">(</span><span class="nv">Schema</span><span class="p">),</span>
</span><span class='line'><span class="nv">Query2</span> <span class="o">=</span> <span class="n">filter</span><span class="p">(</span><span class="nv">Query1</span><span class="p">),</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="nv">Result</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="nv">QueryN</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure> <p>Скорее всего делать внутреннее представление SQL придется через какой-то промежуточный AST, но, у меня есть одно важное требование &ndash; легкое добавление SQL конструкций, которых еще нет в моей библиотеке. Делать полноценный AST который потом бы компилировался в SQL или во что-то еще я не хочу. У меня есть postgresql и это все что мне нужно на данный момент. При такой постановке вопроса проектировать решение становится заметно проще :) Я взял на вооружение подход из моей предыдущей ORM &ndash; добавить дополнительную разметку прямо в SQL</p> <p>Возьмем пример:</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="n">select</span> <span class="n">sum</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">sum</span><span class="p">),</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span> <span class="n">from</span> <span class="n">users</span> <span class="n">as</span> <span class="n">u</span> <span class="n">join</span> <span class="n">orders</span> <span class="n">o</span> <span class="n">on</span> <span class="n">o</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">id</span> <span class="n">where</span> <span class="n">u</span><span class="p">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="mi">18</span> <span class="n">group</span> <span class="n">by</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span>
</span></code></pre></td></tr></table></div></figure> <p>Что понадобится?<br/> Ключевые слова, операции, пробелы, запятые и прочее что должно быть встроено &ldquo;как есть&rdquo; назовем raw (в equery &ndash; <code>{'$raw', iolist()}</code> ).<br/> Названия таблиц повторяются часто и не хотелось бы чтобы при объединении запросов были проблемы с одинаковыми псевдонимами поэтому есть 2 варианта:<br/> 1. генерировать уникальные псевдонимы по ходу построения запроса<br/> 2. генерировать их в самом конце &ndash; при генерации sql, а в ast использовать уникальную &ldquo;ссылку&rdquo;</p> <p>Т.к. posgresql кэширует план запросов &ndash; то нужно чтобы один и тот же код каждый раз давал один и тот же результат.<br/> Следовательно решение 1 отпадает и вводим дополнительную конструкцию {table, UniqueRef} там где нужно ссылаться на поля таблиц. (в equery &ndash; <code>{'$table', ref()}</code>)<br/> Чтобы как-то группировать несколько синтаксических конструкций в одну добавим выражение {exp, [Nodes]} (в equery &ndash; <code>{'$exp', ref()}</code>)<br/> Все остальное считаем данными и при генерации SQL будем их собирать в отдельном списке, а в SQL на этом месте проставлять ссылки на аргументы <code>$1, $2, ...</code></p> <p>В результате sql из примера превращается в AST:</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;select &quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;sum(&quot;</span><span class="p">},</span>
</span><span class='line'>            <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[{</span><span class="n">table</span><span class="p">,</span> <span class="nv">Ref2</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;sum&quot;</span><span class="p">}]},</span>
</span><span class='line'>        <span class="p">{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">}</span>
</span><span class='line'>    <span class="p">]}</span>
</span><span class='line'>    <span class="p">{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[{</span><span class="n">table</span><span class="p">,</span> <span class="nv">Ref1</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">}]},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot; from users as &quot;</span><span class="p">},</span> <span class="p">{</span><span class="n">table</span><span class="p">,</span> <span class="nv">Ref1</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot; join orders as&quot;</span><span class="p">},</span> <span class="p">{</span><span class="n">table</span><span class="p">,</span> <span class="nv">Ref2</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot; on &quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[{</span><span class="n">table</span><span class="p">,</span> <span class="nv">Ref2</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;user_id&quot;</span><span class="p">}]},</span>
</span><span class='line'>        <span class="p">{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot; = &quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[{</span><span class="n">table</span><span class="p">,</span> <span class="nv">Ref1</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">}]},</span>
</span><span class='line'>    <span class="p">]},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot; where &quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[{</span><span class="n">table</span><span class="p">,</span> <span class="nv">Ref1</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">}]},</span>
</span><span class='line'>        <span class="p">{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot; = &quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="mi">18</span>
</span><span class='line'>    <span class="p">]},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot; group by&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[{</span><span class="n">table</span><span class="p">,</span> <span class="nv">Ref1</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">}]}</span>
</span><span class='line'><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure> <p>Как преобразовать такое представление в SQL + Args, думаю вполне очевидно. А вот как строить его с помощью erlang?</p> <p>Для начала нам понадобятся схемы для таблиц:</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nv">UserSchema</span> <span class="o">=</span> <span class="err">#</span><span class="p">{</span>
</span><span class='line'>    <span class="n">fields</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span>
</span><span class='line'>        <span class="n">id</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="n">int</span><span class="p">,</span> <span class="n">index</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span> <span class="n">required</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span> <span class="n">readOnly</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">},</span>
</span><span class='line'>        <span class="n">name</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">varchar</span><span class="p">,</span> <span class="mi">255</span><span class="p">},</span> <span class="n">required</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">},</span>
</span><span class='line'>        <span class="n">age</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="n">int</span><span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="n">table</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&quot;users&quot;</span><span class="o">&gt;&gt;</span>
</span><span class='line'><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nv">OrderSchema</span> <span class="o">=</span> <span class="err">#</span><span class="p">{</span>
</span><span class='line'>    <span class="n">fields</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span>
</span><span class='line'>        <span class="n">id</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="n">int</span><span class="p">,</span> <span class="n">index</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span> <span class="n">required</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span> <span class="n">readOnly</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">},</span>
</span><span class='line'>        <span class="n">user_id</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="n">int</span><span class="p">,</span> <span class="n">required</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">},</span>
</span><span class='line'>        <span class="n">sum</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="n">number</span><span class="p">,</span> <span class="n">required</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="n">table</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&quot;orders&quot;</span><span class="o">&gt;&gt;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> <p>Начнем с того, что должна делать функция <code>from(Schema)</code></p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nv">Query1</span> <span class="o">=</span> <span class="n">from</span><span class="p">(</span><span class="nv">UserSchema</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure> <p>В AST видны повторяющиеся конструкции для ссылок на поля <code>{exp, [{table, Ref1},{raw, "."},{raw, "name"}]}</code>. Следовательно, нужно сгенерировать Ref1 и для каждого поля из схемы построить такое AST выражение. Получится map, который я называю TableData:</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nv">Ref1</span> <span class="o">=</span> <span class="n">make_ref</span><span class="p">(),</span>
</span><span class='line'><span class="err">#</span><span class="p">{</span>
</span><span class='line'>    <span class="n">id</span>   <span class="o">=&gt;</span> <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[{</span><span class="n">table</span><span class="p">,</span> <span class="nv">Ref1</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">}]},</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[{</span><span class="n">table</span><span class="p">,</span> <span class="nv">Ref1</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">}]},</span>
</span><span class='line'>    <span class="n">age</span>  <span class="o">=&gt;</span> <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[{</span><span class="n">table</span><span class="p">,</span> <span class="nv">Ref1</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">},{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">}]},</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> <p>теперь про функции. Для реализации текущего запроса нам нужны функции <code>sum</code> и <code>=</code>. Выглядят они очень просто:</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">sum</span><span class="p">(</span><span class="nv">Field</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;sum(&quot;</span><span class="p">},</span> <span class="nv">F</span><span class="p">,</span> <span class="p">{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">}]}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">&#39;=:=&#39;</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span> <span class="nv">B</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">exp</span><span class="p">,</span> <span class="p">[</span><span class="nv">A</span><span class="p">,</span> <span class="p">{</span><span class="n">raw</span><span class="p">,</span> <span class="s">&quot; = &quot;</span><span class="p">},</span> <span class="nv">B</span><span class="p">]}.</span>
</span></code></pre></td></tr></table></div></figure> <p>Как строить where? Я сделал функцию <code>where(Fun, Query)</code> принимающую Fun, в которую передается несколько TableData уже участвующих в запросе, а на выходе AST для where выражения. Результирующий AST добавляется через and к тому, который уже хранится в Query.</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nv">Query2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">age</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Age</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="n">&#39;=:=&#39;</span><span class="p">(</span><span class="nv">Age</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Query1</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure> <p>С join поступим похожим образом,</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nv">Query3</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="nv">OrderSchema</span><span class="p">,</span> <span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Id</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">user_id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">UserId</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="n">&#39;=:=&#39;</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">UserId</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Query2</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure> <p>для OrderSchema создается OrderTableData и вместе с UserTableData, которая уже есть в запросе передается в callback.</p> <p>Что касается group by то функция тоже очень похожа на предыдущие только возвращает не AST, а массив в котором описано по каким полям группировать</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nv">Query4</span> <span class="o">=</span> <span class="n">group_by</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">_</span><span class="nv">OrdersTableData</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">Name</span><span class="p">]</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Query3</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure> <p>Осталось сделать select. Функция не будет исключением и работает по сходным правила</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nv">Query5</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">sum</span> <span class="p">:</span><span class="o">=</span> <span class="nv">OrderSum</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">Name</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=&gt;</span> <span class="n">sum</span><span class="p">(</span><span class="nv">OrderSum</span><span class="p">)}</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Query4</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure> <p>select callback возвращает описание результата &ndash; это может быть или map или одно поле (удобно для count).</p> <p>Query готов. Осталось только на основе него сгенерировать итоговый Select AST и преобразовать его в SQL. Этим займемся чуть позже. А пока приведу код запроса полностью и попробуем сделать его чуть-чуть красивее.</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nv">Query1</span> <span class="o">=</span> <span class="n">from</span><span class="p">(</span><span class="nv">UserSchema</span><span class="p">),</span>
</span><span class='line'><span class="nv">Query2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">age</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Age</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="n">&#39;=:=&#39;</span><span class="p">(</span><span class="nv">Age</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Query1</span><span class="p">),</span>
</span><span class='line'><span class="nv">Query3</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="nv">OrderSchema</span><span class="p">,</span> <span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Id</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">user_id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">UserId</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="n">&#39;=:=&#39;</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">UserId</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Query2</span><span class="p">),</span>
</span><span class='line'><span class="nv">Query4</span> <span class="o">=</span> <span class="n">group_by</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">_</span><span class="nv">OrdersTableData</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">Name</span><span class="p">]</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Query3</span><span class="p">),</span>
</span><span class='line'><span class="nv">Query5</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">sum</span> <span class="p">:</span><span class="o">=</span> <span class="nv">OrderSum</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">Name</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=&gt;</span> <span class="n">sum</span><span class="p">(</span><span class="nv">OrderSum</span><span class="p">)}</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Query4</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure> <p>Во-первых, давайте перенесем все функции, модифицирующие запрос в отдельный модуль. Для лаконичности q.erl Функции, которые генерирую postgresql AST для операций в другой модуль &ndash; pg_sql.erl</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nv">Query1</span> <span class="o">=</span> <span class="nn">q</span><span class="p">:</span><span class="nf">from</span><span class="p">(</span><span class="nv">UserSchema</span><span class="p">),</span>
</span><span class='line'><span class="nv">Query2</span> <span class="o">=</span> <span class="nn">q</span><span class="p">:</span><span class="nf">where</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">age</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Age</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="nn">pg_sql</span><span class="p">:</span><span class="nf">&#39;=:=&#39;</span><span class="p">(</span><span class="nv">Age</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Query1</span><span class="p">),</span>
</span><span class='line'><span class="nv">Query3</span> <span class="o">=</span> <span class="nn">q</span><span class="p">:</span><span class="nf">join</span><span class="p">(</span><span class="nv">OrderSchema</span><span class="p">,</span> <span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Id</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">user_id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">UserId</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="nn">pg_sql</span><span class="p">:</span><span class="nf">&#39;=:=&#39;</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">UserId</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Query2</span><span class="p">),</span>
</span><span class='line'><span class="nv">Query4</span> <span class="o">=</span> <span class="nn">q</span><span class="p">:</span><span class="nf">group_by</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">_</span><span class="nv">OrdersTableData</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">Name</span><span class="p">]</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Query3</span><span class="p">),</span>
</span><span class='line'><span class="nv">Query5</span> <span class="o">=</span> <span class="nn">q</span><span class="p">:</span><span class="nf">select</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">sum</span> <span class="p">:</span><span class="o">=</span> <span class="nv">OrderSum</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">Name</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=&gt;</span> <span class="nn">pg_sql</span><span class="p">:</span><span class="nf">sum</span><span class="p">(</span><span class="nv">OrderSum</span><span class="p">)}</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Query4</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure> <p>Во-вторых, передавать схему как map не совсем практично. В дальнейшем нам понадобится больше функционала для моделей. Поэтому перенесем каждую схему в свой модуль. Я использую префикс <strong>m_</strong> и функцию <code>schema/0</code>.</p> <p>m_user.erl</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">m_user</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">schema</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">schema</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="err">#</span><span class="p">{</span>
</span><span class='line'>        <span class="n">fields</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span>
</span><span class='line'>            <span class="n">id</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="n">int</span><span class="p">,</span> <span class="n">index</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span> <span class="n">required</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span> <span class="n">readOnly</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">},</span>
</span><span class='line'>            <span class="n">name</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">varchar</span><span class="p">,</span> <span class="mi">255</span><span class="p">},</span> <span class="n">required</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">},</span>
</span><span class='line'>            <span class="n">age</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="n">int</span><span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">table</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&quot;users&quot;</span><span class="o">&gt;&gt;</span>
</span><span class='line'>    <span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure> <p>m_order.erl</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">m_order</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">schema</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">schema</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="err">#</span><span class="p">{</span>
</span><span class='line'>        <span class="n">fields</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span>
</span><span class='line'>            <span class="n">id</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="n">int</span><span class="p">,</span> <span class="n">index</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span> <span class="n">required</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span> <span class="n">readOnly</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">},</span>
</span><span class='line'>            <span class="n">user_id</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="n">int</span><span class="p">,</span> <span class="n">required</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">},</span>
</span><span class='line'>            <span class="n">sum</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="n">number</span><span class="p">,</span> <span class="n">required</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">table</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&quot;orders&quot;</span><span class="o">&gt;&gt;</span>
</span><span class='line'>    <span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure> <p>попутно обучим функции, которые принимали схему принимать модуль и дергать Module:schema() при этом.</p> <p>Теперь возьмемся за то, что ломает глаза и бесит многих, кто приходит в erlang из других языков: повторы QueryN. Ну как решать эту проблему мы-то знаем ;) В elixir для этого существует pipe оператор <code>|&gt;</code>, в erlang его нет, но можно сделать по-другому:</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">pipe</span><span class="p">(</span><span class="nv">State</span><span class="p">,</span> <span class="nv">Funs</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">lists</span><span class="p">:</span><span class="nf">foldl</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">St</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nv">F</span><span class="p">(</span><span class="nv">St</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="nv">Funs</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure> <p>а для каждой функции из q заведем каррированый аналог.</p> <p><code>f(Fun, Query).</code> => <code>f(Fun) -&gt; fun(Query) -&gt; f(Fun, Query) end.</code></p> <p>получилось:</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">q</span><span class="p">:</span><span class="nf">pipe</span><span class="p">(</span><span class="nn">q</span><span class="p">:</span><span class="nf">from</span><span class="p">(</span><span class="n">m_user</span><span class="p">),</span> <span class="p">[</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">where</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">age</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Age</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="nn">pg_sql</span><span class="p">:</span><span class="nf">&#39;=:=&#39;</span><span class="p">(</span><span class="nv">Age</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">join</span><span class="p">(</span><span class="n">m_order</span><span class="p">,</span> <span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Id</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">user_id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">UserId</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="nn">pg_sql</span><span class="p">:</span><span class="nf">&#39;=:=&#39;</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">UserId</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">group_by</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">_</span><span class="nv">OrdersTableData</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">Name</span><span class="p">]</span> <span class="k">end</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">select</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">sum</span> <span class="p">:</span><span class="o">=</span> <span class="nv">OrderSum</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">Name</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=&gt;</span> <span class="nn">pg_sql</span><span class="p">:</span><span class="nf">sum</span><span class="p">(</span><span class="nv">OrderSum</span><span class="p">)}</span> <span class="k">end</span><span class="p">)</span>
</span><span class='line'><span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <p>теперь можно легко переставлять выражения (но порядок все-таки важен)</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">q</span><span class="p">:</span><span class="nf">pipe</span><span class="p">(</span><span class="nn">q</span><span class="p">:</span><span class="nf">from</span><span class="p">(</span><span class="n">m_user</span><span class="p">),</span> <span class="p">[</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">join</span><span class="p">(</span><span class="n">m_order</span><span class="p">,</span> <span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Id</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">user_id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">UserId</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="nn">pg_sql</span><span class="p">:</span><span class="nf">&#39;=:=&#39;</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">UserId</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">select</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">sum</span> <span class="p">:</span><span class="o">=</span> <span class="nv">OrderSum</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">Name</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=&gt;</span> <span class="nn">pg_sql</span><span class="p">:</span><span class="nf">sum</span><span class="p">(</span><span class="nv">OrderSum</span><span class="p">)}</span> <span class="k">end</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">group_by</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">_</span><span class="nv">OrdersTableData</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">Name</span><span class="p">]</span> <span class="k">end</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">where</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">age</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Age</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="nn">pg_sql</span><span class="p">:</span><span class="nf">&#39;=:=&#39;</span><span class="p">(</span><span class="nv">Age</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span>
</span><span class='line'><span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <p>Получился вполне удобный язык запросов, который удовлетворяет всем требованиям которые я описал выше. Все это и немного больше находится в библиотеке <a href="https://github.com/egobrain/equery">equery</a> и пока ее возможностей хватает чтобы покрыть 95% того что мне сейчас нужно (5% &ndash; это union, которых пока нет и выборка из нескольких таблиц <code>select * from table1, table2, ...</code> , но поддержка появится в скором будущем)</p> <p>Маленький бонус. Для тех, кому как и мне, не совсем приятно и удобно читать выражения вида</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">pg_sql</span><span class="p">:</span><span class="nf">&#39;andalso&#39;</span><span class="p">(</span>
</span><span class='line'>    <span class="nn">pg_sql</span><span class="p">:</span><span class="err">&#39;</span><span class="o">&gt;=</span><span class="p">(</span><span class="nv">Age</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">pg_sql</span><span class="p">:</span><span class="nf">&#39;=&lt;&#39;</span><span class="p">(</span><span class="nv">Age</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure> <p>я реализовал parse_transform, который в q callback-ах позволяет писать код в erlang стиле</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nv">Age</span> <span class="o">&gt;=</span> <span class="mi">18</span> <span class="ow">andalso</span> <span class="nv">Age</span> <span class="o">=&lt;</span> <span class="mi">25</span>
</span></code></pre></td></tr></table></div></figure> <p><strong>работает даже в repl !!!</strong> :)</p> <p>с ним наш запрос будет выглядеть так:</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">include_lib</span><span class="p">(</span><span class="s">&quot;equery/include/equery.hrl&quot;</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nv">Query</span> <span class="o">=</span> <span class="nn">q</span><span class="p">:</span><span class="nf">pipe</span><span class="p">(</span><span class="nn">q</span><span class="p">:</span><span class="nf">from</span><span class="p">(</span><span class="n">m_user</span><span class="p">),</span> <span class="p">[</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">where</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">age</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Age</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="nv">Age</span> <span class="o">=:=</span> <span class="mi">18</span> <span class="k">end</span><span class="p">),</span>                                                <span class="c">%% Изменения тут</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">join</span><span class="p">(</span><span class="n">m_order</span><span class="p">,</span> <span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Id</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">user_id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">UserId</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="nv">Id</span> <span class="o">=:=</span> <span class="nv">UserId</span> <span class="k">end</span><span class="p">),</span>      <span class="c">%%  и тут</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">group_by</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">_</span><span class="nv">OrdersTableData</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">Name</span><span class="p">]</span> <span class="k">end</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">select</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">sum</span> <span class="p">:</span><span class="o">=</span> <span class="nv">OrderSum</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">Name</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=&gt;</span> <span class="nn">pg_sql</span><span class="p">:</span><span class="nf">sum</span><span class="p">(</span><span class="nv">OrderSum</span><span class="p">)}</span> <span class="k">end</span><span class="p">)</span>
</span><span class='line'><span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <p>Чтобы получить AST для select запроса нужно вызвать qsql:select/1. А чтобы получить SQL qast:to_sql/1.</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">qast</span><span class="p">:</span><span class="nf">to_sql</span><span class="p">(</span><span class="nn">qsql</span><span class="p">:</span><span class="nf">select</span><span class="p">(</span><span class="nv">Query</span><span class="p">)).</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;select </span><span class="se">\&quot;</span><span class="s">__table-0</span><span class="se">\&quot;</span><span class="s">.</span><span class="se">\&quot;</span><span class="s">name</span><span class="se">\&quot;</span><span class="s">,sum(</span><span class="se">\&quot;</span><span class="s">__table-1</span><span class="se">\&quot;</span><span class="s">.</span><span class="se">\&quot;</span><span class="s">sum</span><span class="se">\&quot;</span><span class="s">) from </span><span class="se">\&quot;</span><span class="s">users</span><span class="se">\&quot;</span><span class="s"> as </span><span class="se">\&quot;</span><span class="s">__table-0</span><span class="se">\&quot;</span><span class="s"> inner join </span><span class="se">\&quot;</span><span class="s">orders</span><span class="se">\&quot;</span><span class="s"> as </span><span class="se">\&quot;</span><span class="s">__table-1</span><span class="se">\&quot;</span><span class="s"> on (</span><span class="se">\&quot;</span><span class="s">__table-0</span><span class="se">\&quot;</span><span class="s">.</span><span class="se">\&quot;</span><span class="s">id</span><span class="se">\&quot;</span><span class="s"> = </span><span class="se">\&quot;</span><span class="s">__table-1</span><span class="se">\&quot;</span><span class="s">.</span><span class="se">\&quot;</span><span class="s">user_id</span><span class="se">\&quot;</span><span class="s">) where (</span><span class="se">\&quot;</span><span class="s">__table-0</span><span class="se">\&quot;</span><span class="s">.</span><span class="se">\&quot;</span><span class="s">age</span><span class="se">\&quot;</span><span class="s"> = $1) group by </span><span class="se">\&quot;</span><span class="s">__table-0</span><span class="se">\&quot;</span><span class="s">.</span><span class="se">\&quot;</span><span class="s">name</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>  <span class="p">[</span><span class="mi">18</span><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure> <h1>REPO</h1> <p>Генерация запросов это хорошо, но хочется еще добавлять, изменять, удалять сущности из БД. Хочется исполнять запросы через pool, иметь хуки на сохранение и т.п. Для этого всего я реализовал библиотеку <a href="https://github.com/egobrain/repo">repo</a>. Она построена поверх <a href="https://github.com/egobrain/equery">equery</a> and <a href="https://github.com/egobrain/epgpool">epgpool</a></p> <h2>Select</h2> <p>С select запросами все совсем просто: пишешь запрос и он исполняется.</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">repo</span><span class="p">:</span><span class="nf">all</span><span class="p">(</span><span class="n">m_user</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">where</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">age</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Age</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="nv">Age</span> <span class="o">=:=</span> <span class="mi">18</span> <span class="k">end</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">join</span><span class="p">(</span><span class="n">m_order</span><span class="p">,</span> <span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Id</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">user_id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">UserId</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="nv">Id</span> <span class="o">=:=</span> <span class="nv">UserId</span> <span class="k">end</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">group_by</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="p">_</span><span class="nv">OrdersTableData</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nv">Name</span><span class="p">]</span> <span class="k">end</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">select</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">},</span> <span class="err">#</span><span class="p">{</span><span class="n">sum</span> <span class="p">:</span><span class="o">=</span> <span class="nv">OrderSum</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">Name</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=&gt;</span> <span class="nn">pg_sql</span><span class="p">:</span><span class="nf">sum</span><span class="p">(</span><span class="nv">OrderSum</span><span class="p">)}</span> <span class="k">end</span><span class="p">)</span>
</span><span class='line'><span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <p>Довольно часто нужно выбрать сущности по какому-то полю или набору полей, например по id. Изначально для этого нужно писать where запрос</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">repo</span><span class="p">:</span><span class="nf">all</span><span class="p">(</span><span class="n">m_user</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">where</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Id</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="nv">Id</span> <span class="o">=:=</span> <span class="mi">123</span> <span class="k">end</span><span class="p">)</span>
</span><span class='line'><span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <p>но, благодаря тому, что запросы легко строить динамически можно добавить немного сахара:</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">like</span><span class="p">(</span><span class="nv">Map</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">q</span><span class="p">:</span><span class="nf">where</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="nv">M</span><span class="p">|_])</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nn">maps</span><span class="p">:</span><span class="nf">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="k">fun</span><span class="p">(</span><span class="nv">K</span><span class="p">,</span> <span class="nv">V</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="k">case</span> <span class="nn">maps</span><span class="p">:</span><span class="nf">find</span><span class="p">(</span><span class="nv">K</span><span class="p">,</span> <span class="nv">M</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>                    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">V2</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nv">S</span> <span class="ow">andalso</span> <span class="nv">V</span> <span class="o">=:=</span> <span class="nv">V2</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">error</span> <span class="o">-&gt;</span> <span class="nv">S</span>
</span><span class='line'>                <span class="k">end</span>
</span><span class='line'>            <span class="k">end</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="nv">Map</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nn">repo</span><span class="p">:</span><span class="nf">all</span><span class="p">(</span><span class="n">m_user</span><span class="p">,</span> <span class="p">[</span> <span class="n">like</span><span class="p">(</span><span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">123</span><span class="p">}</span> <span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <p>я пошел еще дальше и repo api принимает map на вход.</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">repo</span><span class="p">:</span><span class="nf">all</span><span class="p">(</span><span class="n">m_user</span><span class="p">,</span> <span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">123</span><span class="p">}).</span> <span class="c">%% просто, понятно, лаконично</span>
</span></code></pre></td></tr></table></div></figure> <p>для поиска единственного элемента есть функция get_one</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">User</span><span class="p">}</span> <span class="o">=</span> <span class="nn">repo</span><span class="p">:</span><span class="nf">get_one</span><span class="p">(</span><span class="n">m_user</span><span class="p">,</span> <span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">123</span><span class="p">}).</span>
</span></code></pre></td></tr></table></div></figure> <p>Если результат запроса слишком большой, но при этом его можно обрабатывать потоково (например вывод отчета с большим количеством полей) то желательно использовать потоковое api через <a href="https://github.com/egobrain/zlist">zlist</a>, что сильно уменьшает latency и потребление памяти, т.к. данные из БД подгружаются пачками по мере необходимости</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">repo</span><span class="p">:</span><span class="nf">all</span><span class="p">(</span><span class="n">m_user</span><span class="p">,</span> <span class="p">[</span><span class="nn">q</span><span class="p">:</span><span class="nf">where</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">age</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Age</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="nv">Age</span> <span class="o">&gt;</span> <span class="mi">18</span> <span class="k">end</span><span class="p">)],</span> <span class="k">fun</span><span class="p">(</span><span class="nv">ZList</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">zlist</span><span class="p">:</span><span class="nf">foreach</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Name</span><span class="p">,</span> <span class="n">age</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Age</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;User: </span><span class="si">~p</span><span class="s">, </span><span class="si">~p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Name</span><span class="p">,</span> <span class="nv">Age</span><span class="p">])</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Zlist</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure> <p>Чуть не забыл. С помощью repo_utils:preload/1 можно подгружать данные из зависимых таблиц (has_many, belongs_to). Например:</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">m_user</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">schema</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">schema</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="err">#</span><span class="p">{</span>
</span><span class='line'>        <span class="n">fields</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span>
</span><span class='line'>            <span class="n">id</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="n">int</span><span class="p">,</span> <span class="n">index</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span> <span class="n">required</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">,</span> <span class="n">readOnly</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">},</span>
</span><span class='line'>            <span class="n">name</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">varchar</span><span class="p">,</span> <span class="mi">255</span><span class="p">},</span> <span class="n">required</span> <span class="o">=&gt;</span> <span class="n">true</span><span class="p">},</span>
</span><span class='line'>            <span class="n">age</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">type</span> <span class="o">=&gt;</span> <span class="n">int</span><span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">links</span> <span class="o">=&gt;</span> <span class="err">#</span><span class="p">{</span>
</span><span class='line'>            <span class="n">orders</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">has_many</span><span class="p">,</span> <span class="n">m_order</span><span class="p">,</span> <span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="o">=&gt;</span> <span class="n">user_id</span><span class="p">}}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">table</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&quot;users&quot;</span><span class="o">&gt;&gt;</span>
</span><span class='line'>    <span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure> <p>запрос</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">repo</span><span class="p">:</span><span class="nf">all</span><span class="p">(</span><span class="n">m_user</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>    <span class="nn">repo_utils</span><span class="p">:</span><span class="nf">preload</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>
</span><span class='line'><span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <p>вернет подобную структуру</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">[</span><span class="err">#</span><span class="p">{</span>
</span><span class='line'>    <span class="n">id</span> <span class="o">=&gt;</span> <span class="nv">UserId</span><span class="p">,</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">=&gt;</span> <span class="nv">UserName</span><span class="p">,</span>
</span><span class='line'>    <span class="n">age</span> <span class="o">=&gt;</span> <span class="nv">UserAge</span><span class="p">,</span>
</span><span class='line'>    <span class="n">orders</span> <span class="o">=&gt;</span> <span class="p">[</span>
</span><span class='line'>         <span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="o">=&gt;</span> <span class="nv">OrderId1</span><span class="p">,</span>  <span class="n">user_id</span> <span class="o">=&gt;</span> <span class="nv">UserId</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=&gt;</span> <span class="nv">Sum1</span><span class="p">},</span>
</span><span class='line'>         <span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="o">=&gt;</span> <span class="nv">OrderId2</span><span class="p">,</span>  <span class="n">user_id</span> <span class="o">=&gt;</span> <span class="nv">UserId</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=&gt;</span> <span class="nv">Sum2</span><span class="p">},</span>
</span><span class='line'>         <span class="p">...</span>
</span><span class='line'> <span class="p">},</span>
</span><span class='line'> <span class="p">...</span> <span class="nv">Other</span> <span class="n">users</span> <span class="p">...</span>
</span><span class='line'><span class="p">].</span>
</span></code></pre></td></tr></table></div></figure> <p>и все это одним SQL запросом.</p> <h2>Insert/Update/Upsert</h2> <p>С insert/update все очень просто. API принимает один или несколько объектов и по-умолчанию возвращает их же (через sql returnging)</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">repo</span><span class="p">:</span><span class="nf">insert</span><span class="p">(</span><span class="n">m_user</span><span class="p">,</span> <span class="p">[</span><span class="err">#</span><span class="p">{</span><span class="n">name</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&quot;Alladin&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">age</span> <span class="o">=&gt;</span> <span class="mi">25</span><span class="p">},</span> <span class="p">...]).</span>
</span></code></pre></td></tr></table></div></figure> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">repo</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span><span class="n">m_user</span><span class="p">,</span> <span class="p">[</span><span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="o">=</span> <span class="mi">238</span><span class="p">,</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&quot;Masha&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">age</span> <span class="o">=&gt;</span> <span class="mi">18</span><span class="p">},</span> <span class="p">...]).</span>
</span></code></pre></td></tr></table></div></figure> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">repo</span><span class="p">:</span><span class="nf">upsert</span><span class="p">(</span><span class="n">m_user</span><span class="p">,</span> <span class="p">[</span><span class="err">#</span><span class="p">{</span><span class="n">id</span> <span class="o">=</span> <span class="mi">239</span><span class="p">,</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="o">&lt;&lt;</span><span class="s">&quot;Igor&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">age</span> <span class="o">=&gt;</span> <span class="mi">18</span><span class="p">},</span> <span class="p">...]).</span>
</span></code></pre></td></tr></table></div></figure> <p>Хочется добавить, что для каждой модели можно, при необходимости, объявить <code>before_save/2</code> и <code>after_save/2</code> hook-и и, если хочется хранить сущности не в мапах, а, скажем, в record-ах, для этого есть <code>from_db/1</code> и <code>to_db/1</code> (для примера смотри <a href="https://github.com/egobrain/repo/blob/0.4.0/test/models/m_user.erl#L31">common тесты</a>)</p> <h2>Batch update</h2> <p>Можно обновлять сущности пачкой, а не по одному:</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">repo</span><span class="p">:</span><span class="nf">set</span><span class="p">(</span><span class="n">m_user</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>   <span class="nn">q</span><span class="p">:</span><span class="nf">set</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">age</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Age</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="err">#</span><span class="p">{</span><span class="n">age</span> <span class="o">=&gt;</span> <span class="nv">Age</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">}</span> <span class="k">end</span><span class="p">)</span>
</span><span class='line'><span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <h2>Batch delete</h2> <p>Удаляются данные только пачкой.</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">repo</span><span class="p">:</span><span class="nf">delete</span><span class="p">(</span><span class="n">m_user</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>   <span class="nn">q</span><span class="p">:</span><span class="nf">where</span><span class="p">(</span><span class="k">fun</span><span class="p">([</span><span class="err">#</span><span class="p">{</span><span class="n">age</span> <span class="p">:</span><span class="o">=</span> <span class="nv">Age</span><span class="p">}])</span> <span class="o">-&gt;</span> <span class="nv">Age</span> <span class="o">&gt;</span> <span class="mi">99</span> <span class="k">end</span><span class="p">)</span>
</span><span class='line'><span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure> <h2>Резюме</h2> <p>На данный момент я не считаю что реализация repo идеальна и эталонна, но она решает большую часть повседневных задач стоящих в моих проектах и уже успешно используется в production. Нет ничего плохого в том, чтобы форкуть его и заменить, докрутить его части так как это необходимо именно вам, т.к. проект очень маленький и при этом ~100% покрыт тестами.</p> <p>При этом проект позволил полностью избавиться от генерации SQL вручную (кроме миграций) и заметно сократить общий объем кодовой базы. Стоит однако понимать, что библиотека equery не контролирует ошибки генерации sql, зато дает больший контроль во взаимодействии с Postgresql т.к. вы можете самостоятельно реализовать почти любую синтаксическую конструкцию. Вам необходимо понимать что и как происходи и где копать в случае проблем. Именно поэтому я привел описание как все работает выше. Хорошо это или нет &ndash; решать вам.</p> <h1>Дальнейшие планы</h1> <p>Предстоит еще не мало работы:<br/> &ndash; добавить unioun, multiple from в equery<br/> &ndash; покрыть все спеками и dialyzer тестами<br/> &ndash; написать документацию<br/> &ndash; добавить больше common операций в equery pg_sql.erl<br/> &ndash; реализовать dbschema-repo addon чтобы автоматически генерировать миграции для изменения схем</p> <p>Основным недостатком (вероятно для некоторых) что проект ориентирован только на Posgresql и при том 9.5 версии (из-за upsert)</p> <p>Буду рад комментариям и PR :)</p> </div> </article> <article> <header> <h1 class="entry-title"><a href="/blog/2014/02/26/erlang-orm-part-2/">Erlang ORM. Часть 2</a></h1> <p class="meta"> <time datetime="2014-02-26T06:22:23+04:00" pubdate data-updated="true">Ср, 26 Фев 2014</time> </p> </header> <div class="entry-content"><p>В <a href="/blog/2014/02/19/erlang-orm-part-1">прошлой части</a> я говорил про генерацию модели, но так и не осветил как соединить генерацию моделей и работу с БД. Сейчас это исправлю.</p> </div> <footer> <a rel="full-article" href="/blog/2014/02/26/erlang-orm-part-2/">Читать далее &rarr;</a> </footer> </article> <article> <header> <h1 class="entry-title"><a href="/blog/2014/02/19/erlang-orm-part-1/">Erlang ORM. Часть 1.</a></h1> <p class="meta"> <time datetime="2014-02-19T11:19:24+04:00" pubdate data-updated="true">Ср, 19 Фев 2014</time> </p> </header> <div class="entry-content"><p>Всем известно, что в Erlang нет привычных объектов из &ldquo;классического&rdquo; ООП, но они, по сути, и не нужны. Под словом объект, в данном случае, будет пониматься связка структура (record) и модуль, в котором описаны все функции для работы с этой структурой.</p> <p>Приведу пример, который буду рассматривать на протяжении всех своих рассуждений:</p> <p>Классический объект &ndash; User с полями login, email, password и salt (куда без нее). Его можно описать так (приставка <em>db_</em> &ndash; необходима, т.к. в erlang уже есть модуль с таким именем).</p> <figure class='code'><figcaption><span>db_user.erl </span></figcaption> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">db_user</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">db_user</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">login</span><span class="p">,</span>
</span><span class='line'>    <span class="n">email</span><span class="p">,</span>
</span><span class='line'>    <span class="n">password</span><span class="p">,</span>
</span><span class='line'>    <span class="n">salt</span>
</span><span class='line'><span class="p">}).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">new</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nl">#db_user</span><span class="p">{}.</span>
</span></code></pre></td></tr></table></div></figure> <p>Я хочу описать два своих проекта <a href="http://github.com/egobrain/tq_transform">tq_transform</a> и <a href="http://github.com/egobrain/tq_db">tq_db</a>. Которые суммарно генерируют объект позволяющий:</p> <ol> <li>Прятать реализацию, т.е. объекты за пределами модуля db_user не должны работать с record-ом напрямую. Это позволит в случае необходимости с легкостью поменять record, к примеру, на map.</li> <li>Задавать значения по умолчанию.</li> <li>Работать с &ldquo;внешним миром&rdquo;. Существует возможность указать какие поля и доступны для отправки внешнему пользователю ( к примеру через REST api ) и в каком виде, какие нет, какие только для чтения, какие только для записи.</li> <li>Конвертировать содержимое полей в/из proplist.</li> <li>Выводить список измененных полей.</li> <li>Задавать валидаторы как отдельных полей, так и всей модели в целом.</li> <li>Проводить загрузку модели в/из БД, притом представление полей в БД и Erlang может отличаться. <ol> <li>При обновлении модели, подставлять в SQL запрос только обновленные поля.</li> <li>Задавать хуки на события: <code>before_save</code>, <code>after_save</code>, <code>before_delete</code>, <code>after_delete</code></li> </ol> </li> </ol> </div> <footer> <a rel="full-article" href="/blog/2014/02/19/erlang-orm-part-1/">Читать далее &rarr;</a> </footer> </article> <article> <header> <h1 class="entry-title"><a href="/blog/2014/02/13/obrabotka-oshibok-poumolchaniiu-angularjs/">Обработка ошибок по умолчанию AngularJS</a></h1> <p class="meta"> <time datetime="2014-02-13T15:36:38+04:00" pubdate data-updated="true">Чт, 13 Фев 2014</time> </p> </header> <div class="entry-content"><p>При работе c REST Api со страницы SPA часто возникает необходимость обработки ошибок. Все бы ничего, но часть ответов об ошибках касаются запрашиваемых данных, часть &ndash; могут быть ошибками общего вида c которыми тоже надо что-то делать. Предлагаю свое решение данной проблемы.</p> </div> <footer> <a rel="full-article" href="/blog/2014/02/13/obrabotka-oshibok-poumolchaniiu-angularjs/">Читать далее &rarr;</a> </footer> </article> <div class="pagination"> <a href="/blog/archives">Архив заметок</a> </div> </div> <aside class="sidebar"> <section> <h1>Коротко о себе</h1> <p> Привет! Меня зовут Яков. Этой мой блог об erlang, js, web-программировании, fp и прочем&#8230; </p> <p> Связаться со мной можно по @почте: xazar.studio@gmail.com </p> </section> <section> <h1>Недавние заметки</h1> <ul id="recent_posts"> <li class="post"> <a href="/blog/2016/06/02/erlang-orm-part-3/">Erlang ORM. часть 3</a> </li> <li class="post"> <a href="/blog/2014/02/26/erlang-orm-part-2/">Erlang ORM. Часть 2</a> </li> <li class="post"> <a href="/blog/2014/02/19/erlang-orm-part-1/">Erlang ORM. Часть 1.</a> </li> <li class="post"> <a href="/blog/2014/02/13/obrabotka-oshibok-poumolchaniiu-angularjs/">Обработка ошибок по умолчанию AngularJS</a> </li> </ul> </section> <section> <h1>GitHub Repos</h1> <ul id="gh_repos"> <li class="loading">Status updating&#8230;</li> </ul> <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'egobrain',
            count: 0,
            skip_forks: true,
            skip_projects: [ "dip_orm",  "egobrain.github.io",  "erlperf_tests", ],
            target: '#gh_repos'
        });
    });
  </script> <script src="/javascripts/github.js" type="text/javascript"> </script> </section> <section class="googleplus"> <h1> <a href="https://plus.google.com/113605909138563391004?rel=author"> <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32"> Google+ </a> </h1> </section> </aside> </div> </div> <footer role="contentinfo"><p> Copyright &copy; 2016 - Kozlov Yakov - <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> </p> </footer> <script type="text/javascript">
      var disqus_shortname = 'wwwegobrainru';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script> <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script> <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script> <script type="text/javascript">
(function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter24052423 = new Ya.Metrika({id:24052423, enableAll: true});
        } catch(e) {}
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f);
    } else { f(); }
})(document, window, "yandex_metrika_callbacks");
</script> <noscript><div><img src="//mc.yandex.ru/watch/24052423" style="position:absolute; left:-9999px;" alt=""/></div></noscript> </body> </html>